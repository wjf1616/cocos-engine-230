
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/renderer/utils/dynamic-atlas/manager.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

var Atlas = require('./atlas');

var _atlases = [];

var _atlasIndex = -1;

var _maxAtlasCount = 5;
var _textureSize = 2048;
var _maxFrameSize = 512;
var _textureBleeding = true;
var _debugNode = null;

function newAtlas() {
  var atlas = _atlases[++_atlasIndex];

  if (!atlas) {
    atlas = new Atlas(_textureSize, _textureSize);

    _atlases.push(atlas);
  }

  return atlas;
}

function beforeSceneLoad() {
  dynamicAtlasManager.reset();
}

var _enabled = false;
/**
 * !#en Manager the dynamic atlas.
 * !#zh 管理动态图集。
 * @class DynamicAtlasManager
 */

var dynamicAtlasManager = {
  Atlas: Atlas,

  /**
   * !#en Enabled or Disabled dynamic atlas.
   * !#zh 开启或者关闭动态图集。
   * @property enabled
   * @type {Boolean}
   */
  get enabled() {
    return _enabled;
  },

  set enabled(value) {
    if (_enabled === value) return;

    if (value) {
      this.reset();
      cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH, beforeSceneLoad);
    } else {
      cc.director.off(cc.Director.EVENT_BEFORE_SCENE_LAUNCH, beforeSceneLoad);
    }

    _enabled = value;
  },

  /**
   * !#en The maximum number of atlas that can be created.
   * !#zh 可以创建的最大图集数量。
   * @property maxAtlasCount
   * @type {Number}
   */
  get maxAtlasCount() {
    return _maxAtlasCount;
  },

  set maxAtlasCount(value) {
    _maxAtlasCount = value;
  },

  /**
   * !#en Is enable textureBleeding.
   * !#zh 是否开启 textureBleeding
   * @property textureBleeding
   * @type {Boolean}
   */
  get textureBleeding() {
    return _textureBleeding;
  },

  set textureBleeding(enable) {
    _textureBleeding = enable;
  },

  /**
   * !#en The size of the atlas that was created
   * !#zh 创建的图集的宽高
   * @property textureSize
   * @type {Number}
   */
  get textureSize() {
    return _textureSize;
  },

  set textureSize(value) {
    _textureSize = value;
  },

  /**
   * !#en The maximum size of the picture that can be added to the atlas.
   * !#zh 可以添加进图集的图片的最大尺寸。
   * @property maxFrameSize
   * @type {Number}
   */
  get maxFrameSize() {
    return _maxFrameSize;
  },

  set maxFrameSize(value) {
    _maxFrameSize = value;
  },

  /**
   * !#en The minimum size of the picture that can be added to the atlas.
   * !#zh 可以添加进图集的图片的最小尺寸。
   * @property minFrameSize
   * @type {Number}
   * @deprecated
   */

  /**
   * !#en Append a sprite frame into the dynamic atlas.
   * !#zh 添加碎图进入动态图集。
   * @method insertSpriteFrame
   * @param {SpriteFrame} spriteFrame 
   */
  insertSpriteFrame: function insertSpriteFrame(spriteFrame) {
    if (CC_EDITOR) return null;
    if (!_enabled || _atlasIndex === _maxAtlasCount || !spriteFrame || spriteFrame._original) return null;
    if (!spriteFrame._texture.packable) return null;
    var atlas = _atlases[_atlasIndex];

    if (!atlas) {
      atlas = newAtlas();
    }

    var frame = atlas.insertSpriteFrame(spriteFrame);

    if (!frame && _atlasIndex !== _maxAtlasCount) {
      atlas = newAtlas();
      return atlas.insertSpriteFrame(spriteFrame);
    }

    return frame;
  },

  /** 
   * !#en Resets all dynamic atlas, and the existing ones will be destroyed.
   * !#zh 重置所有动态图集，已有的动态图集会被销毁。
   * @method reset
  */
  reset: function reset() {
    for (var i = 0, l = _atlases.length; i < l; i++) {
      _atlases[i].destroy();
    }

    _atlases.length = 0;
    _atlasIndex = -1;
  },
  deleteAtlasSpriteFrame: function deleteAtlasSpriteFrame(spriteFrame) {
    if (!spriteFrame._original) return;
    var texture = spriteFrame._original._texture;
    this.deleteAtlasTexture(texture);
  },
  deleteAtlasTexture: function deleteAtlasTexture(texture) {
    if (texture) {
      for (var i = _atlases.length - 1; i >= 0; i--) {
        _atlases[i].deleteInnerTexture(texture);

        if (_atlases[i].isEmpty()) {
          _atlases[i].destroy();

          _atlases.splice(i, 1);

          _atlasIndex--;
        }
      }
    }
  },

  /**
   * !#en Displays all the dynamic atlas in the current scene, which you can use to view the current atlas state.
   * !#zh 在当前场景中显示所有动态图集，可以用来查看当前的合图状态。
   * @method showDebug
   * @param {Boolean} show
   */
  showDebug: CC_DEV && function (show) {
    if (show) {
      if (!_debugNode || !_debugNode.isValid) {
        var width = cc.visibleRect.width;
        var height = cc.visibleRect.height;
        _debugNode = new cc.Node('DYNAMIC_ATLAS_DEBUG_NODE');
        _debugNode.width = width;
        _debugNode.height = height;
        _debugNode.x = width / 2;
        _debugNode.y = height / 2;
        _debugNode.zIndex = cc.macro.MAX_ZINDEX;
        _debugNode.parent = cc.director.getScene();
        _debugNode.groupIndex = cc.Node.BuiltinGroupIndex.DEBUG;

        cc.Camera._setupDebugCamera();

        var scroll = _debugNode.addComponent(cc.ScrollView);

        var content = new cc.Node('CONTENT');
        var layout = content.addComponent(cc.Layout);
        layout.type = cc.Layout.Type.VERTICAL;
        layout.resizeMode = cc.Layout.ResizeMode.CONTAINER;
        content.parent = _debugNode;
        content.width = _textureSize;
        content.anchorY = 1;
        content.x = _textureSize;
        scroll.content = content;

        for (var i = 0; i <= _atlasIndex; i++) {
          var node = new cc.Node('ATLAS');
          var texture = _atlases[i]._texture;
          var spriteFrame = new cc.SpriteFrame();
          spriteFrame.setTexture(_atlases[i]._texture);
          var sprite = node.addComponent(cc.Sprite);
          sprite.spriteFrame = spriteFrame;
          node.parent = content;
        }
      }
    } else {
      if (_debugNode) {
        _debugNode.parent = null;
        _debugNode = null;
      }
    }
  },
  update: function update() {
    if (!this.enabled) return;

    for (var i = 0; i <= _atlasIndex; i++) {
      _atlases[i].update();
    }
  }
};
/**
 * @module cc
 */

/**
 * @property dynamicAtlasManager
 * @type DynamicAtlasManager
 */

module.exports = cc.dynamicAtlasManager = dynamicAtlasManager;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hbmFnZXIuanMiXSwibmFtZXMiOlsiQXRsYXMiLCJyZXF1aXJlIiwiX2F0bGFzZXMiLCJfYXRsYXNJbmRleCIsIl9tYXhBdGxhc0NvdW50IiwiX3RleHR1cmVTaXplIiwiX21heEZyYW1lU2l6ZSIsIl90ZXh0dXJlQmxlZWRpbmciLCJfZGVidWdOb2RlIiwibmV3QXRsYXMiLCJhdGxhcyIsInB1c2giLCJiZWZvcmVTY2VuZUxvYWQiLCJkeW5hbWljQXRsYXNNYW5hZ2VyIiwicmVzZXQiLCJfZW5hYmxlZCIsImVuYWJsZWQiLCJ2YWx1ZSIsImNjIiwiZGlyZWN0b3IiLCJvbiIsIkRpcmVjdG9yIiwiRVZFTlRfQkVGT1JFX1NDRU5FX0xBVU5DSCIsIm9mZiIsIm1heEF0bGFzQ291bnQiLCJ0ZXh0dXJlQmxlZWRpbmciLCJlbmFibGUiLCJ0ZXh0dXJlU2l6ZSIsIm1heEZyYW1lU2l6ZSIsImluc2VydFNwcml0ZUZyYW1lIiwic3ByaXRlRnJhbWUiLCJDQ19FRElUT1IiLCJfb3JpZ2luYWwiLCJfdGV4dHVyZSIsInBhY2thYmxlIiwiZnJhbWUiLCJpIiwibCIsImxlbmd0aCIsImRlc3Ryb3kiLCJkZWxldGVBdGxhc1Nwcml0ZUZyYW1lIiwidGV4dHVyZSIsImRlbGV0ZUF0bGFzVGV4dHVyZSIsImRlbGV0ZUlubmVyVGV4dHVyZSIsImlzRW1wdHkiLCJzcGxpY2UiLCJzaG93RGVidWciLCJDQ19ERVYiLCJzaG93IiwiaXNWYWxpZCIsIndpZHRoIiwidmlzaWJsZVJlY3QiLCJoZWlnaHQiLCJOb2RlIiwieCIsInkiLCJ6SW5kZXgiLCJtYWNybyIsIk1BWF9aSU5ERVgiLCJwYXJlbnQiLCJnZXRTY2VuZSIsImdyb3VwSW5kZXgiLCJCdWlsdGluR3JvdXBJbmRleCIsIkRFQlVHIiwiQ2FtZXJhIiwiX3NldHVwRGVidWdDYW1lcmEiLCJzY3JvbGwiLCJhZGRDb21wb25lbnQiLCJTY3JvbGxWaWV3IiwiY29udGVudCIsImxheW91dCIsIkxheW91dCIsInR5cGUiLCJUeXBlIiwiVkVSVElDQUwiLCJyZXNpemVNb2RlIiwiUmVzaXplTW9kZSIsIkNPTlRBSU5FUiIsImFuY2hvclkiLCJub2RlIiwiU3ByaXRlRnJhbWUiLCJzZXRUZXh0dXJlIiwic3ByaXRlIiwiU3ByaXRlIiwidXBkYXRlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLElBQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBRUEsSUFBSUMsUUFBUSxHQUFHLEVBQWY7O0FBQ0EsSUFBSUMsV0FBVyxHQUFHLENBQUMsQ0FBbkI7O0FBRUEsSUFBSUMsY0FBYyxHQUFHLENBQXJCO0FBQ0EsSUFBSUMsWUFBWSxHQUFHLElBQW5CO0FBQ0EsSUFBSUMsYUFBYSxHQUFHLEdBQXBCO0FBQ0EsSUFBSUMsZ0JBQWdCLEdBQUcsSUFBdkI7QUFFQSxJQUFJQyxVQUFVLEdBQUcsSUFBakI7O0FBRUEsU0FBU0MsUUFBVCxHQUFxQjtBQUNqQixNQUFJQyxLQUFLLEdBQUdSLFFBQVEsQ0FBQyxFQUFFQyxXQUFILENBQXBCOztBQUNBLE1BQUksQ0FBQ08sS0FBTCxFQUFZO0FBQ1JBLElBQUFBLEtBQUssR0FBRyxJQUFJVixLQUFKLENBQVVLLFlBQVYsRUFBd0JBLFlBQXhCLENBQVI7O0FBQ0FILElBQUFBLFFBQVEsQ0FBQ1MsSUFBVCxDQUFjRCxLQUFkO0FBQ0g7O0FBQ0QsU0FBT0EsS0FBUDtBQUNIOztBQUVELFNBQVNFLGVBQVQsR0FBNEI7QUFDeEJDLEVBQUFBLG1CQUFtQixDQUFDQyxLQUFwQjtBQUNIOztBQUVELElBQUlDLFFBQVEsR0FBRyxLQUFmO0FBRUE7Ozs7OztBQUtBLElBQUlGLG1CQUFtQixHQUFHO0FBQ3RCYixFQUFBQSxLQUFLLEVBQUVBLEtBRGU7O0FBR3RCOzs7Ozs7QUFNQSxNQUFJZ0IsT0FBSixHQUFlO0FBQ1gsV0FBT0QsUUFBUDtBQUNILEdBWHFCOztBQVl0QixNQUFJQyxPQUFKLENBQWFDLEtBQWIsRUFBb0I7QUFDaEIsUUFBSUYsUUFB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Q0FBQ2tDLENBQUQsQ0FBUixDQUFZZ0QsTUFBWjtBQUNIO0FBQ0o7QUFuTnFCLENBQTFCO0FBc05BOzs7O0FBSUE7Ozs7O0FBSUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBFLEVBQUUsQ0FBQ0wsbUJBQUgsR0FBeUJBLG1CQUExQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEF0bGFzID0gcmVxdWlyZSgnLi9hdGxhcycpO1xuXG5sZXQgX2F0bGFzZXMgPSBbXTtcbmxldCBfYXRsYXNJbmRleCA9IC0xO1xuXG5sZXQgX21heEF0bGFzQ291bnQgPSA1O1xubGV0IF90ZXh0dXJlU2l6ZSA9IDIwNDg7XG5sZXQgX21heEZyYW1lU2l6ZSA9IDUxMjtcbmxldCBfdGV4dHVyZUJsZWVkaW5nID0gdHJ1ZTtcblxubGV0IF9kZWJ1Z05vZGUgPSBudWxsO1xuXG5mdW5jdGlvbiBuZXdBdGxhcyAoKSB7XG4gICAgbGV0IGF0bGFzID0gX2F0bGFzZXNbKytfYXRsYXNJbmRleF1cbiAgICBpZiAoIWF0bGFzKSB7XG4gICAgICAgIGF0bGFzID0gbmV3IEF0bGFzKF90ZXh0dXJlU2l6ZSwgX3RleHR1cmVTaXplKTtcbiAgICAgICAgX2F0bGFzZXMucHVzaChhdGxhcyk7XG4gICAgfVxuICAgIHJldHVybiBhdGxhcztcbn1cblxuZnVuY3Rpb24gYmVmb3JlU2NlbmVMb2FkICgpIHtcbiAgICBkeW5hbWljQXRsYXNNYW5hZ2VyLnJlc2V0KCk7XG59XG5cbmxldCBfZW5hYmxlZCA9IGZhbHNlO1xuXG4vKipcbiAqICEjZW4gTWFuYWdlciB0aGUgZHluYW1pYyBhdGxhcy5cbiAqICEjemgg566h55CG5Yqo5oCB5Zu+6ZuG44CCXG4gKiBAY2xhc3MgRHluYW1pY0F0bGFzTWFuYWdlclxuICovXG5sZXQgZHluYW1pY0F0bGFzTWFuYWdlciA9IHtcbiAgICBBdGxhczogQXRsYXMsXG4gICAgXG4gICAgLyoqXG4gICAgICogISNlbiBFbmFibGVkIG9yIERpc2FibGVkIGR5bmFtaWMgYXRsYXMuXG4gICAgICogISN6aCDlvIDlkK/miJbogIXlhbPpl63liqjmgIHlm77pm4bjgIJcbiAgICAgKiBAcHJvcGVydHkgZW5hYmxlZFxuICAgICAqIEB0eXBlIHtCb29sZWFufVxuICAgICAqL1xuICAgIGdldCBlbmFibGVkICgpIHtcbiAgICAgICAgcmV0dXJuIF9lbmFibGVkO1xuICAgIH0sXG4gICAgc2V0IGVuYWJsZWQgKHZhbHVlKSB7XG4gICAgICAgIGlmIChfZW5hYmxlZCA9PT0gdmFsdWUpIHJldHVybjtcblxuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMucmVzZXQoKTtcbiAgICAgICAgICAgIGNjLmRpcmVjdG9yLm9uKGNjLkRpcmVjdG9yLkVWRU5UX0JFRk9SRV9TQ0VORV9MQVVOQ0gsIGJlZm9yZVNjZW5lTG9hZCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjYy5kaXJlY3Rvci5vZmYoY2MuRGlyZWN0b3IuRVZFTlRfQkVGT1JFX1NDRU5FX0xBVU5DSCwgYmVmb3JlU2NlbmVMb2FkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIF9lbmFibGVkID0gdmFsdWU7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqICEjZW4gVGhlIG1heGltdW0gbnVtYmVyIG9mIGF0bGFzIHRoYXQgY2FuIGJlIGNyZWF0ZWQuXG4gICAgICogISN6aCDlj6/ku6XliJvlu7rnmoTmnIDlpKflm77pm4bmlbDph4/jgIJcbiAgICAgKiBAcHJvcGVydHkgbWF4QXRsYXNDb3VudFxuICAgICAqIEB0eXBlIHtOdW1iZXJ9XG4gICAgICovXG4gICAgZ2V0IG1heEF0bGFzQ291bnQgKCkge1xuICAgICAgICByZXR1cm4gX21heEF0bGFzQ291bnQ7XG4gICAgfSxcbiAgICBzZXQgbWF4QXRsYXNDb3VudCAodmFsdWUpIHtcbiAgICAgICAgX21heEF0bGFzQ291bnQgPSB2YWx1ZTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogISNlbiBJcyBlbmFibGUgdGV4dHVyZUJsZWVkaW5nLlxuICAgICAqICEjemgg5piv5ZCm5byA5ZCvIHRleHR1cmVCbGVlZGluZ1xuICAgICAqIEBwcm9wZXJ0eSB0ZXh0dXJlQmxlZWRpbmdcbiAgICAgKiBAdHlwZSB7Qm9vbGVhbn1cbiAgICAgKi9cbiAgICBnZXQgdGV4dHVyZUJsZWVkaW5nICgpIHtcbiAgICAgICAgcmV0dXJuIF90ZXh0dXJlQmxlZWRpbmc7XG4gICAgfSxcblxuICAgIHNldCB0ZXh0dXJlQmxlZWRpbmcgKGVuYWJsZSkge1xuICAgICAgICBfdGV4dHVyZUJsZWVkaW5nID0gZW5hYmxlO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiAhI2VuIFRoZSBzaXplIG9mIHRoZSBhdGxhcyB0aGF0IHdhcyBjcmVhdGVkXG4gICAgICogISN6aCDliJvlu7rnmoTlm77pm4bnmoTlrr3pq5hcbiAgICAgKiBAcHJvcGVydHkgdGV4dHVyZVNpemVcbiAgICAgKiBAdHlwZSB7TnVtYmVyfVxuICAgICAqL1xuICAgIGdldCB0ZXh0dXJlU2l6ZSAoKSB7XG4gICAgICAgIHJldHVybiBfdGV4dHVyZVNpemU7XG4gICAgfSxcbiAgICBzZXQgdGV4dHVyZVNpemUgKHZhbHVlKSB7XG4gICAgICAgIF90ZXh0dXJlU2l6ZSA9IHZhbHVlO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiAhI2VuIFRoZSBtYXhpbXVtIHNpemUgb2YgdGhlIHBpY3R1cmUgdGhhdCBjYW4gYmUgYWRkZWQgdG8gdGhlIGF0bGFzLlxuICAgICAqICEjemgg5Y+v5Lul5re75Yqg6L+b5Zu+6ZuG55qE5Zu+54mH55qE5pyA5aSn5bC65a+444CCXG4gICAgICogQHByb3BlcnR5IG1heEZyYW1lU2l6ZVxuICAgICAqIEB0eXBlIHtOdW1iZXJ9XG4gICAgICovXG4gICAgZ2V0IG1heEZyYW1lU2l6ZSAoKSB7XG4gICAgICAgIHJldHVybiBfbWF4RnJhbWVTaXplO1xuICAgIH0sXG4gICAgc2V0IG1heEZyYW1lU2l6ZSAodmFsdWUpIHtcbiAgICAgICAgX21heEZyYW1lU2l6ZSA9IHZhbHVlO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiAhI2VuIFRoZSBtaW5pbXVtIHNpemUgb2YgdGhlIHBpY3R1cmUgdGhhdCBjYW4gYmUgYWRkZWQgdG8gdGhlIGF0bGFzLlxuICAgICAqICEjemgg5Y+v5Lul5re75Yqg6L+b5Zu+6ZuG55qE5Zu+54mH55qE5pyA5bCP5bC65a+444CCXG4gICAgICogQHByb3BlcnR5IG1pbkZyYW1lU2l6ZVxuICAgICAqIEB0eXBlIHtOdW1iZXJ9XG4gICAgICogQGRlcHJlY2F0ZWRcbiAgICAgKi9cbiAgICBcbiAgICAvKipcbiAgICAgKiAhI2VuIEFwcGVuZCBhIHNwcml0ZSBmcmFtZSBpbnRvIHRoZSBkeW5hbWljIGF0bGFzLlxuICAgICAqICEjemgg5re75Yqg56KO5Zu+6L+b5YWl5Yqo5oCB5Zu+6ZuG44CCXG4gICAgICogQG1ldGhvZCBpbnNlcnRTcHJpdGVGcmFtZVxuICAgICAqIEBwYXJhbSB7U3ByaXRlRnJhbWV9IHNwcml0ZUZyYW1lIFxuICAgICAqL1xuICAgIGluc2VydFNwcml0ZUZyYW1lIChzcHJpdGVGcmFtZSkge1xuICAgICAgICBpZiAoQ0NfRURJVE9SKSByZXR1cm4gbnVsbDtcbiAgICAgICAgaWYgKCFfZW5hYmxlZCB8fCBfYXRsYXNJbmRleCA9PT0gX21heEF0bGFzQ291bnQgfHxcbiAgICAgICAgICAgICFzcHJpdGVGcmFtZSB8fCBzcHJpdGVGcmFtZS5fb3JpZ2luYWwpIHJldHVybiBudWxsO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFzcHJpdGVGcmFtZS5fdGV4dHVyZS5wYWNrYWJsZSkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgbGV0IGF0bGFzID0gX2F0bGFzZXNbX2F0bGFzSW5kZXhdO1xuICAgICAgICBpZiAoIWF0bGFzKSB7XG4gICAgICAgICAgICBhdGxhcyA9IG5ld0F0bGFzKCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZnJhbWUgPSBhdGxhcy5pbnNlcnRTcHJpdGVGcmFtZShzcHJpdGVGcmFtZSk7XG4gICAgICAgIGlmICghZnJhbWUgJiYgX2F0bGFzSW5kZXggIT09IF9tYXhBdGxhc0NvdW50KSB7XG4gICAgICAgICAgICBhdGxhcyA9IG5ld0F0bGFzKCk7XG4gICAgICAgICAgICByZXR1cm4gYXRsYXMuaW5zZXJ0U3ByaXRlRnJhbWUoc3ByaXRlRnJhbWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcmFtZTtcbiAgICB9LFxuXG4gICAgLyoqIFxuICAgICAqICEjZW4gUmVzZXRzIGFsbCBkeW5hbWljIGF0bGFzLCBhbmQgdGhlIGV4aXN0aW5nIG9uZXMgd2lsbCBiZSBkZXN0cm95ZWQuXG4gICAgICogISN6aCDph43nva7miYDmnInliqjmgIHlm77pm4bvvIzlt7LmnInnmoTliqjmgIHlm77pm4bkvJrooqvplIDmr4HjgIJcbiAgICAgKiBAbWV0aG9kIHJlc2V0XG4gICAgKi9cbiAgICByZXNldCAoKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gX2F0bGFzZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICBfYXRsYXNlc1tpXS5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgICAgX2F0bGFzZXMubGVuZ3RoID0gMDtcbiAgICAgICAgX2F0bGFzSW5kZXggPSAtMTtcbiAgICB9LFxuXG4gICAgZGVsZXRlQXRsYXNTcHJpdGVGcmFtZSAoc3ByaXRlRnJhbWUpIHtcbiAgICAgICAgaWYgKCFzcHJpdGVGcmFtZS5fb3JpZ2luYWwpIHJldHVybjtcblxuICAgICAgICBsZXQgdGV4dHVyZSA9IHNwcml0ZUZyYW1lLl9vcmlnaW5hbC5fdGV4dHVyZTtcbiAgICAgICAgdGhpcy5kZWxldGVBdGxhc1RleHR1cmUodGV4dHVyZSk7XG4gICAgfSxcblxuICAgIGRlbGV0ZUF0bGFzVGV4dHVyZSAodGV4dHVyZSkge1xuICAgICAgICBpZiAodGV4dHVyZSkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IF9hdGxhc2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgX2F0bGFzZXNbaV0uZGVsZXRlSW5uZXJUZXh0dXJlKHRleHR1cmUpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChfYXRsYXNlc1tpXS5pc0VtcHR5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgX2F0bGFzZXNbaV0uZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgICAgICBfYXRsYXNlcy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgICAgIF9hdGxhc0luZGV4LS07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqICEjZW4gRGlzcGxheXMgYWxsIHRoZSBkeW5hbWljIGF0bGFzIGluIHRoZSBjdXJyZW50IHNjZW5lLCB3aGljaCB5b3UgY2FuIHVzZSB0byB2aWV3IHRoZSBjdXJyZW50IGF0bGFzIHN0YXRlLlxuICAgICAqICEjemgg5Zyo5b2T5YmN5Zy65pmv5Lit5pi+56S65omA5pyJ5Yqo5oCB5Zu+6ZuG77yM5Y+v5Lul55So5p2l5p+l55yL5b2T5YmN55qE5ZCI5Zu+54q25oCB44CCXG4gICAgICogQG1ldGhvZCBzaG93RGVidWdcbiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHNob3dcbiAgICAgKi9cbiAgICBzaG93RGVidWc6IENDX0RFViAmJiBmdW5jdGlvbiAoc2hvdykge1xuICAgICAgICBpZiAoc2hvdykge1xuICAgICAgICAgICAgaWYgKCFfZGVidWdOb2RlIHx8ICFfZGVidWdOb2RlLmlzVmFsaWQpIHtcbiAgICAgICAgICAgICAgICBsZXQgd2lkdGggPSBjYy52aXNpYmxlUmVjdC53aWR0aDtcbiAgICAgICAgICAgICAgICBsZXQgaGVpZ2h0ID0gY2MudmlzaWJsZVJlY3QuaGVpZ2h0O1xuXG4gICAgICAgICAgICAgICAgX2RlYnVnTm9kZSA9IG5ldyBjYy5Ob2RlKCdEWU5BTUlDX0FUTEFTX0RFQlVHX05PREUnKTtcbiAgICAgICAgICAgICAgICBfZGVidWdOb2RlLndpZHRoID0gd2lkdGg7XG4gICAgICAgICAgICAgICAgX2RlYnVnTm9kZS5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgICAgICAgICAgX2RlYnVnTm9kZS54ID0gd2lkdGgvMjtcbiAgICAgICAgICAgICAgICBfZGVidWdOb2RlLnkgPSBoZWlnaHQvMjtcbiAgICAgICAgICAgICAgICBfZGVidWdOb2RlLnpJbmRleCA9IGNjLm1hY3JvLk1BWF9aSU5ERVg7XG4gICAgICAgICAgICAgICAgX2RlYnVnTm9kZS5wYXJlbnQgPSBjYy5kaXJlY3Rvci5nZXRTY2VuZSgpO1xuXG4gICAgICAgICAgICAgICAgX2RlYnVnTm9kZS5ncm91cEluZGV4ID0gY2MuTm9kZS5CdWlsdGluR3JvdXBJbmRleC5ERUJVRztcbiAgICAgICAgICAgICAgICBjYy5DYW1lcmEuX3NldHVwRGVidWdDYW1lcmEoKTtcblxuICAgICAgICAgICAgICAgIGxldCBzY3JvbGwgPSBfZGVidWdOb2RlLmFkZENvbXBvbmVudChjYy5TY3JvbGxWaWV3KTtcblxuICAgICAgICAgICAgICAgIGxldCBjb250ZW50ID0gbmV3IGNjLk5vZGUoJ0NPTlRFTlQnKTtcbiAgICAgICAgICAgICAgICBsZXQgbGF5b3V0ID0gY29udGVudC5hZGRDb21wb25lbnQoY2MuTGF5b3V0KTtcbiAgICAgICAgICAgICAgICBsYXlvdXQudHlwZSA9IGNjLkxheW91dC5UeXBlLlZFUlRJQ0FMO1xuICAgICAgICAgICAgICAgIGxheW91dC5yZXNpemVNb2RlID0gY2MuTGF5b3V0LlJlc2l6ZU1vZGUuQ09OVEFJTkVSO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQucGFyZW50ID0gX2RlYnVnTm9kZTtcbiAgICAgICAgICAgICAgICBjb250ZW50LndpZHRoID0gX3RleHR1cmVTaXplO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuYW5jaG9yWSA9IDE7XG4gICAgICAgICAgICAgICAgY29udGVudC54ID0gX3RleHR1cmVTaXplO1xuXG4gICAgICAgICAgICAgICAgc2Nyb2xsLmNvbnRlbnQgPSBjb250ZW50O1xuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gX2F0bGFzSW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgbm9kZSA9IG5ldyBjYy5Ob2RlKCdBVExBUycpO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRleHR1cmUgPSBfYXRsYXNlc1tpXS5fdGV4dHVyZTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNwcml0ZUZyYW1lID0gbmV3IGNjLlNwcml0ZUZyYW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZUZyYW1lLnNldFRleHR1cmUoX2F0bGFzZXNbaV0uX3RleHR1cmUpO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBzcHJpdGUgPSBub2RlLmFkZENvbXBvbmVudChjYy5TcHJpdGUpXG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZS5zcHJpdGVGcmFtZSA9IHNwcml0ZUZyYW1lO1xuXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50ID0gY29udGVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBpZiAoX2RlYnVnTm9kZSkge1xuICAgICAgICAgICAgICAgIF9kZWJ1Z05vZGUucGFyZW50ID0gbnVsbDtcbiAgICAgICAgICAgICAgICBfZGVidWdOb2RlID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICB1cGRhdGUgKCkge1xuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgcmV0dXJuO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IF9hdGxhc0luZGV4OyBpKyspIHtcbiAgICAgICAgICAgIF9hdGxhc2VzW2ldLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfSxcbn07XG5cbi8qKlxuICogQG1vZHVsZSBjY1xuICovXG5cbi8qKlxuICogQHByb3BlcnR5IGR5bmFtaWNBdGxhc01hbmFnZXJcbiAqIEB0eXBlIER5bmFtaWNBdGxhc01hbmFnZXJcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSBjYy5keW5hbWljQXRsYXNNYW5hZ2VyID0gZHluYW1pY0F0bGFzTWFuYWdlcjsiXX0=