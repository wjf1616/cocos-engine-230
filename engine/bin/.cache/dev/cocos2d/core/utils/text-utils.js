
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/utils/text-utils.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

var _js = _interopRequireDefault(require("../platform/js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/****************************************************************************
 Copyright (c) 2013-2016 Chukong Technologies Inc.
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
 worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
 not use Cocos Creator software for developing other software or tools that's
 used for developing games. You are not granted to publish, distribute,
 sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
// Draw text the textBaseline ratio (Can adjust the appropriate baseline ratio based on the platform)
var _BASELINE_RATIO = 0.26;

if (CC_RUNTIME) {
  _BASELINE_RATIO = -0.05;
}

var MAX_CACHE_SIZE = 100;
var pool = new _js["default"].Pool(2);

pool.get = function () {
  var node = this._get() || {
    key: null,
    value: null,
    prev: null,
    next: null
  };
  return node;
};

function LRUCache(size) {
  this.count = 0;
  this.limit = size;
  this.datas = {};
  this.head = null;
  this.tail = null;
}

LRUCache.prototype.moveToHead = function (node) {
  node.next = this.head;
  node.prev = null;
  if (this.head !== null) this.head.prev = node;
  this.head = node;
  if (this.tail === null) this.tail = node;
  this.count++;
  this.datas[node.key] = node;
};

LRUCache.prototype.put = function (key, value) {
  var node = pool.get();
  node.key = key;
  node.value = value;

  if (this.count >= this.limit) {
    var discard = this.tail;
    delete this.datas[discard.key];
    this.count--;
    this.tail = discard.prev;
    this.tail.next = null;
    discard.prev = null;
    discard.next = null;
    pool.put(discard);
  }

  this.moveToHead(node);
};

LRUCache.prototype.remove = function (node) {
  if (node.prev !== null) {
    node.prev.next = node.next;
  } else {
    this.head = node.next;
  }

  if (node.next !== null) {
    node.next.prev = node.prev;
  } else {
    this.tail = node.prev;
  }

  delete this.datas[node.key];
  this.count--;
};

LRUCache.prototype.get = function (key) {
  var node = this.datas[key];

  if (node) {
    this.remove(node);
    this.moveToHead(node);
    return node.value;
  }

  return null;
};

LRUCache.prototype.clear = function () {
  this.count = 0;
  this.datas = {};
  this.head = null;
  this.tail = null;
};

LRUCache.prototype.has = function (key) {
  return !!this.datas[key];
};

LRUCache.prototype["delete"] = function (key) {
  var node = this.datas[key];
  this.remove(node);
};

var measureCache = new LRUCache(MAX_CACHE_SIZE);
var textUtils = {
  BASELINE_RATIO: _BASELINE_RATIO,
  MIDDLE_RATIO: (_BASELINE_RATIO + 1) / 2 - _BASELINE_RATIO,
  label_wordRex: /([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,
  label_symbolRex: /^[!,.:;'}\]%\?>、‘“》？。，！]/,
  label_lastWordRex: /([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,
  label_lastEnglish: /[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,
  label_firstEnglish: /^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/,
  label_firstEmoji: /^[\uD83C\uDF00-\uDFFF\uDC00-\uDE4F]/,
  label_lastEmoji: /([\uDF00-\uDFFF\uDC00-\uDE4F]+|\S)$/,
  label_wrapinspection: true,
  __CHINESE_REG: /^[\u4E00-\u9FFF\u3400-\u4DFF]+$/,
  __JAPANESE_REG: /[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g,
  __KOREAN_REG: /^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/,
  isUnicodeCJK: function isUnicodeCJK(ch) {
    return this.__CHINESE_REG.test(ch) || this.__JAPANESE_REG.test(ch) || this.__KOREAN_REG.test(ch);
  },
  //Checking whether the character is a whitespace
  isUnicodeSpace: function isUnicodeSpace(ch) {
    ch = ch.charCodeAt(0);
    return ch >= 9 && ch <= 13 || ch === 32 || ch === 133 || ch === 160 || ch === 5760 || ch >= 8192 && ch <= 8202 || ch === 8232 || ch === 8233 || ch === 8239 || ch === 8287 || ch === 12288;
  },
  safeMeasureText: function safeMeasureText(ctx, string, desc) {
    var font = desc || ctx.font;
    var key = font + "\uD83C\uDFAE" + string;
    var cache = measureCache.get(key);

    if (cache !== null) {
      return cache;
    }

    var metric = ctx.measureText(string);
    var width = metric && metric.width || 0;
    measureCache.put(key, width);
    return width;
  },
  fragmentText: function fragmentText(stringToken, allWidth, maxWidth, measureText) {
    //check the first character
    var wrappedWords = []; //fast return if strArr is empty

    if (stringToken.length === 0 || maxWidth < 0) {
      wrappedWords.push('');
      return wrappedWords;
    }

    var text = stringToken;

    while (allWidth > maxWidth && text.length > 1) {
      var fuzzyLen = text.length * (maxWidth / allWidth) | 0;
      var tmpText = text.substring(fuzzyLen);
      var width = allWidth - measureText(tmpText);
      var sLine = tmpText;
      var pushNum = 0;
      var checkWhile = 0;
      var checkCount = 10; //Exceeded the size

      while (width > maxWidth && checkWhile++ < checkCount) {
        fuzzyLen *= maxWidth / width;
        fuzzyLen = fuzzyLen | 0;
        tmpText = text.substring(fuzzyLen);
        width = allWidth - measureText(tmpText);
      }

      checkWhile = 0; //Find the truncation point

      while (width <= maxWidth && checkWhile++ < checkCount) {
        if (tmpText) {
          var exec = this.label_wordRex.exec(tmpText);
          pushNum = exec ? exec[0].length : 1;
          sLine = tmpText;
        }

        fuzzyLen = fuzzyLen + pushNum;
        tmpText = text.substring(fuzzyLen);
        width = allWidth - measureText(tmpText);
      }

      fuzzyLen -= pushNum;

      if (fuzzyLen === 0) {
        fuzzyLen = 1;
        sLine = sLine.substring(1);
      }

      var sText = text.substring(0, 0 + fuzzyLen),
          result; //symbol in the first

      if (this.label_wrapinspection) {
        if (this.label_symbolRex.test(sLine || tmpText)) {
          result = this.label_lastWordRex.exec(sText);
          fuzzyLen -= result ? result[0].length : 0;
          if (fuzzyLen === 0) fuzzyLen = 1;
          sLine = text.substring(fuzzyLen);
          sText = text.substring(0, 0 + fuzzyLen);
        }
      } // To judge whether a Emoji words are truncated
      // todo Some Emoji are not well adapted, such as 🚗 and 🇨🇳


      if (this.label_firstEmoji.test(sLine)) {
        result = this.label_lastEmoji.exec(sText);

        if (result && sText !== result[0]) {
          fuzzyLen -= result[0].length;
          sLine = text.substring(fuzzyLen);
          sText = text.substring(0, 0 + fuzzyLen);
        }
      } //To judge whether a English words are truncated


      if (this.label_firstEnglish.test(sLine)) {
        result = this.label_lastEnglish.exec(sText);

        if (result && sText !== result[0]) {
          fuzzyLen -= result[0].length;
          sLine = text.substring(fuzzyLen);
          sText = text.substring(0, 0 + fuzzyLen);
        }
      } // The first line And do not wrap should not remove the space


      if (wrappedWords.length === 0) {
        wrappedWords.push(sText);
      } else {
        sText = sText.trimLeft();

        if (sText.length > 0) {
          wrappedWords.push(sText);
        }
      }

      text = sLine || tmpText;
      allWidth = measureText(text);
    }

    if (wrappedWords.length === 0) {
      wrappedWords.push(text);
    } else {
      text = text.trimLeft();

      if (text.length > 0) {
        wrappedWords.push(text);
      }
    }

    return wrappedWords;
  }
};
cc.textUtils = module.exports = textUtils;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRleHQtdXRpbHMuanMiXSwibmFtZXMiOlsiX0JBU0VMSU5FX1JBVElPIiwiQ0NfUlVOVElNRSIsIk1BWF9DQUNIRV9TSVpFIiwicG9vbCIsImpzIiwiUG9vbCIsImdldCIsIm5vZGUiLCJfZ2V0Iiwia2V5IiwidmFsdWUiLCJwcmV2IiwibmV4dCIsIkxSVUNhY2hlIiwic2l6ZSIsImNvdW50IiwibGltaXQiLCJkYXRhcyIsImhlYWQiLCJ0YWlsIiwicHJvdG90eXBlIiwibW92ZVRvSGVhZCIsInB1dCIsImRpc2NhcmQiLCJyZW1vdmUiLCJjbGVhciIsImhhcyIsIm1lYXN1cmVDYWNoZSIsInRleHRVdGlscyIsIkJBU0VMSU5FX1JBVElPIiwiTUlERExFX1JBVElPIiwibGFiZWxfd29yZFJleCIsImxhYmVsX3N5bWJvbFJleCIsImxhYmVsX2xhc3RXb3JkUmV4IiwibGFiZWxfbGFzdEVuZ2xpc2giLCJsYWJlbF9maXJzdEVuZ2xpc2giLCJsYWJlbF9maXJzdEVtb2ppIiwibGFiZWxfbGFzdEVtb2ppIiwibGFiZWxfd3JhcGluc3BlY3Rpb24iLCJfX0NISU5FU0VfUkVHIiwiX19KQVBBTkVTRV9SRUciLCJfX0tPUkVBTl9SRUciLCJpc1VuaWNvZGVDSksiLCJjaCIsInRlc3QiLCJpc1VuaWNvZGVTcGFjZSIsImNoYXJDb2RlQXQiLCJzYWZlTWVhc3VyZVRleHQiLCJjdHgiLCJzdHJpbmciLCJkZXNjIiwiZm9udCIsImNhY2hlIiwibWV0cmljIiwibWVhc3VyZVRleHQiLCJ3aWR0aCIsImZyYWdtZW50VGV4dCIsInN0cmluZ1Rva2VuIiwiYWxsV2lkdGgiLCJtYXhXaWR0aCIsIndyYXBwZWRXb3JkcyIsImxlbmd0aCIsInB1c2giLCJ0ZXh0IiwiZnV6enlMZW4iLCJ0bXBUZXh0Iiwic3Vic3RyaW5nIiwic0xpbmUiLCJwdXNoTnVtIiwiY2hlY2tXaGlsZSIsImNoZWNrQ291bnQiLCJleGVjIiwic1RleHQiLCJyZXN1bHQiLCJ0cmltTGVmdCIsImNjIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQTBCQTs7OztBQTFCQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTRCQTtBQUNBLElBQUlBLGVBQWUsR0FBRyxJQUF0Qjs7QUFDQSxJQUFJQyxVQUFKLEVBQWdCO0FBQ1pELEVBQUFBLGVBQWUsR0FBRyxDQUFDLElBQW5CO0FBQ0g7O0FBRUQsSUFBTUUsY0FBYyxHQUFHLEdBQXZCO0FBRUEsSUFBSUMsSUFBSSxHQUFHLElBQUlDLGVBQUdDLElBQVAsQ0FBWSxDQUFaLENBQVg7O0FBQ0FGLElBQUksQ0FBQ0csR0FBTCxHQUFXLFlBQVk7QUFDbkIsTUFBSUMsSUFBSSxHQUFHLEtBQUtDLElBQUwsTUFBZTtBQUN0QkMsSUFBQUEsR0FBRyxFQUFFLElBRGlCO0FBRXRCQyxJQUFBQSxLQUFLLEVBQUUsSUFGZTtBQUd0QkMsSUFBQUEsSUFBSSxFQUFFLElBSGdCO0FBSXRCQyxJQUFBQSxJQUFJLEVBQUU7QUFKZ0IsR0FBMUI7QUFPQSxTQUFPTCxJQUFQO0FBQ0gsQ0FURDs7QUFXQSxTQUFTTSxRQUFULENBQWtCQyxJQUFsQixFQUF3QjtBQUNwQixPQUFLQyxLQUFMLEdBQWEsQ0FBYjtBQUNBLE9BQUtDLEtBQUwsR0FBYUYsSUFBYjtBQUNBLE9BQUtHLEtBQUwsR0FBYSxFQUFiO0FBQ0EsT0FBS0MsSUFBTCxHQUFZLElBQVo7QUFDQSxPQUFLQyxJQUFMLEdBQVksSUFBWjtBQUNIOztBQUVETixRQUFRLENBQUNPLFNBQVQsQ0FBbUJDLFVBQW5CLEdBQWdDLFVBQVVkLElBQVYsRUFBZ0I7QUFDNUNBLEVBQUFBLElBQUksQ0FBQ0ssSUFBTCxHQUFZLEtBQUtNLElBQWpCO0FBQ0FYLEVBQUFBLElBQUksQ0FBQ0ksSUFBTCxHQUFZLElBQVo7QUFDQSxNQUFJLEtBQUtPLElBQUwsS0FBYyxJQUFsQixFQUNJLEtBQUtBLElBQUwsQ0FBVVAsSUFBVixHQUFpQkosSUFBakI7QUFDSixPQUFLVyxJQUFMLEdBQVlYLElBQVo7QUFDQSxNQUFJLEtBQUtZLElBQUwsS0FBYyxJQUFsQixFQUNJLEtBQUtBLElBQUwsR0FBWVosSUFBWjtBQUNKLE9BQUtRLEtBQUw7QUFDQSxPQUFLRSxLQUFMLENBQVdWLElBQUksQ0FBQ0UsR0FBaEIsSUFBdUJGLElBQXZCO0FBQ0gsQ0FWRDs7QUFZQU0sUUFBUSxDQUFDTyxTQUFULENBQW1CRSxHQUFuQixHQUF5QixVQUFVYixHQUFWLEVBQWVDLEtBQWYsRUFBc0I7QUFDM0MsTUFBTUgsSUFBSSxHQUFHSixJQUFJLENBQUNHLEdBQUwsRUFBYjtBQUNBQyxFQUFBQSxJQUFJLENBQUNFLEdBQUwsR0FBV0EsR0FBWDtBQUNBRixFQUFBQSxJQUFJLENBQUNHLEtBQUwsR0FBYUEsS0FBYjs7QUFFQSxNQUFJLEtBQUtLLEtBQUwsSUFBYyxLQUFLQyxLQUF2QixFQUE4QjtBQUMxQixRQUFJTyxPQUFPLEdBQUcsS0FBS0osSUFBbkI7QUFDQSxXQUFPLEtBQUtGLEtBQUwsQ0FBV00sT0FBTyxDQUFDZCxHQUFuQixDQUFQO0FBQ0EsU0FBS00sS0FBTDtBQUNBLFNBQUtJLElBQUwsR0FBWUksT0FBTyxDQUFDWixJQUFwQjtBQUNBLFNBQUtRLElBQUwsQ0FBVVAsSUFBVixHQUFpQixJQUFqQjtBQUNBVyxJQUFBQSxPQUFPLENBQUNaLElBQVIsR0FBZSxJQUFmO0FBQ0FZLElBQUFBLE9BQU8sQ0FBQ1gsSUFBUixHQUFlLElBQWY7QUFDQVQsSUFBQUEsSUFBSSxDQUFDbUIsR0FBTCxDQUFTQyxPQUFUO0FBQ0g7O0FBQ0QsT0FBS0YsVUFBTCxDQUFnQmQsSUFBaEI7QUFDSCxDQWhCRDs7QUFrQkFNLFFBQVEsQ0FBQ08sU0FBVCxDQUFtQkksTUFBbkIsR0FBNEIsVUFBVWpCLElBQVYsRUFBZ0I7QUFDeEMsTUFBSUEsSUFBSSxDQUFDSSxJQUFMLEtBQWMsSUFBbEIsRUFBd0I7QUFDcEJKLElBQUFBLElBQUksQ0FBQ0ksSUFBTCxDQUFVQyxJQUFWLEdBQWlCTCxJQUFJLENBQUNLLElBQXRCO0FBQ0gsR0FGRCxNQUVPO0FBQ0gsU0FBS00sSUFBTCxHQUFZWCxJQUFJLENBQUNLLElBQWpCO0FBQ0g7O0FBQ0QsTUFBSUwsSUFBSSxDQUFDSyxJQUFMLEtBQWMsSUFBbEIsRUFBd0I7QUFDcEJMLElBQUFBLElBQUksQ0FBQ0ssSUFBTCxDQUFVRCxJQUFWLEdBQWlCSixJQUFJLENBQUNJLElBQXRCO0FBQ0gsR0FGRCxNQUVPO0FBQ0gsU0FBS1EsSUFBTCxHQUFZWixJQUFJLENBQUNJLElBQWpCO0FBQ0g7O0FBQ0QsU0FBTyxLQUFLTSxLQUFMLENBQVdWLElBQUksQ0FBQ0UsR0FBaEIsQ0FBUDtBQUNBLE9BQUtNLEtBQUw7QUFDSCxDQWJEOztBQWVBRixRQUFRLENBQUNPLFNBQVQsQ0FBbUJkLEdBQW5CLEdBQXlCLFVBQVVHLEdBQVYsRUFBZTtBQUNwQyxNQUFNRixJQUFJLEdBQUcsS0FBS1UsS0FBTCxDQUFXUixHQUFYLENBQWI7O0FBQ0EsTUFBSUYsSUFBSixFQUFVO0FBQ04sU0FBS2lCLE1BQUwsQ0FBWWpCLElBQVo7QUFDQSxTQUFLYyxVQUFMLENBQWdCZCxJQUFoQjtBQUNBLFdBQU9BLElBQUksQ0FBQ0csS0FBWjtBQUNIOztBQUNELFNBQU8sSUFBUDtBQUNILENBUkQ7O0FBVUFHLFFBQVEsQ0FBQ08sU0FBVCxDQUFtQkssS0FBbkIsR0FBMkIsWUFBWTtBQUNuQyxPQUFLVixLQUFMLEdBQWEsQ0FBYjtBQUNBLE9BQUtFLEtBQUwsR0FBYSxFQUFiO0FBQ0EsT0FBS0MsSUFBTCxHQUFZLElBQVo7QUFDQSxPQUFLQyxJQUFMLEdBQVksSUFBWjtBQUNILENBTEQ7O0FBT0FOLFFBQVEsQ0FBQ08sU0FBVCxDQUFtQk0sR0FBbkIsR0FBeUIsVUFBVWpCLEdBQVYsRUFBZTtBQUNwQyxTQUFPLENBQUMsQ0FBQyxLQUFLUSxLQUFMLENBQVdSLEdBQVgsQ0FBVDtBQUNILENBRkQ7O0FBSUFJLFFBQVEsQ0FBQ08sU0FBVCxhQUE0QixVQUFVWCxHQUFWLEVBQWU7QUFDdkMsTUFBTUYsSUFBSSxHQUFHLEtBQUtVLEtBQUwsQ0FBV1IsR0FBWCxDQUFiO0FBQ0EsT0FBS2UsTUFBTCxDQUFZakIsSUFBWjtBQUNILENBSEQ7O0FBS0EsSUFBSW9CLFlBQVksR0FBRyxJQUFJZCxRQUFKLENBQWFYLGNBQWIsQ0FBbkI7QUFFQSxJQUFJMEIsU0FBUyxHQUFHO0FBRVpDLEVBQUFBLGNBQWMsRUFBRTdCLGVBRko7QUFHWjhCLEVBQUFBLFlBQVksRUFBRSxDQUFDOUIsZUFBZSxHQUFHLENBQW5CLElBQXdCLENBQXhCLEdBQTRCQSxlQUg5QjtBQUtaK0IsRUFBQUEsYUFBYSxFQUFHLDRDQUxKO0FBTVpDLEVBQUFBLGVBQWUsRUFBRywwQkFOTjtBQU9aQyxFQUFBQSxpQkFBaUIsRUFBRywwSEFQUjtBQVFaQyxFQUFBQSxpQkFBaUIsRUFBRyxxSEFSUjtBQVNaQyxFQUFBQSxrQkFBa0IsRUFBRyxvSEFUVDtBQVVaQyxFQUFBQSxnQkFBZ0IsRUFBRyxxQ0FWUDtBQVdaQyxFQUFBQSxlQUFlLEVBQUcscUNBWE47QUFZWkMsRUFBQUEsb0JBQW9CLEVBQUcsSUFaWDtBQWNaQyxFQUFBQSxhQUFhLEVBQUUsaUNBZEg7QUFlWkMsRUFBQUEsY0FBYyxFQUFFLHlIQWZKO0FBZ0JaQyxFQUFBQSxZQUFZLEVBQUUsb0ZBaEJGO0FBa0JaQyxFQUFBQSxZQUFZLEVBQUUsc0JBQVNDLEVBQVQsRUFBYTtBQUN2QixXQUFPLEtBQUtKLGFBQUwsQ0FBbUJLLElBQW5CLENBQXdCRCxFQUF4QixLQUErQixLQUFLSCxjQUFMLENBQW9CSSxJQUFwQixDQUF5QkQsRUFBekIsQ0FBL0IsSUFBK0QsS0FBS0YsWUFBTCxDQUFrQkcsSUFBbEIsQ0FBdUJELEVBQXZCLENBQXRFO0FBQ0gsR0FwQlc7QUFzQlo7QUFDQUUsRUFBQUEsY0FBYyxFQUFFLHdCQUFTRixFQUFULEVBQWE7QUFDekJBLElBQUFBLEVBQUUsR0FBR0EsRUFBRSxDQUFDRyxVQUFILENBQWMsQ0FBZCxDQUFMO0FBQ0EsV0FBU0gsRUFBRSxJQUFJLENBQU4sSUFBV0EsRUFBRSxJQUFJLEVBQWxCLElBQXlCQSxFQUFFLEtBQUssRUFBaEMsSUFBc0NBLEVBQUUsS0FBSyxHQUE3QyxJQUFvREEsRUFBRSxLQUFLLEdBQTNELElBQWtFQSxFQUFFLEtBQUssSUFBekUsSUFBa0ZBLEVBQUUsSUFBSSxJQUFOLElBQWNBLEVBQUUsSUFBSSxJQUF0RyxJQUErR0EsRUFBRSxLQUFLLElBQXRILElBQThIQSxFQUFFLEtBQUssSUFBckksSUFBNklBLEVBQUUsS0FBSyxJQUFwSixJQUE0SkEsRUFBRSxLQUFLLElBQW5LLElBQTJLQSxFQUFFLEtBQUssS0FBMUw7QUFDSCxHQTFCVztBQTRCWkksRUFBQUEsZUFBZSxFQUFFLHlCQUFVQyxHQUFWLEVBQWVDLE1BQWYsRUFBdUJDLElBQXZCLEVBQTZCO0FBQzFDLFFBQUlDLElBQUksR0FBR0QsSUFBSSxJQUFJRixHQUFHLENBQUNHLElBQXZCO0FBQ0EsUUFBSTFDLEdBQUcsR0FBRzBDLElBQUksR0FBRyxjQUFQLEdBQXdCRixNQUFsQztBQUNBLFFBQUlHLEtBQUssR0FBR3pCLFlBQVksQ0FBQ3JCLEdBQWIsQ0FBaUJHLEdBQWpCLENBQVo7O0FBQ0EsUUFBSTJDLEtBQUssS0FBSyxJQUFkLEVBQW9CO0FBQ2hCLGFBQU9BLEtBQVA7QUFDSDs7QUFFRCxRQUFJQyxNQUFNLEdBQUdMLEdBQUcsQ0FBQ00sV0FBSixDQUFnQkwsTUFBaEIsQ0FBYjtBQUNBLFFBQUlNLEtBQUssR0FBR0YsTUFBTSxJQUFJQSxNQUFNLENBQUNFLEtBQWpCLElBQTBCLENBQXRDO0FBQ0E1QixJQUFBQSxZQUFZLENBQUNMLEdBQWIsQ0FBaUJiLEdBQWpCLEVBQXNCOEMsS0FBdEI7QUFFQSxXQUFPQSxLQUFQO0FBQ0gsR0F6Q1c7QUEyQ1pDLEVBQUFBLFlBQVksRUFBRSxzQkFBVUMsV0FBVixFQUF1QkMsUUFBdkIsRUFBaUNDLFFBQWpDLEVBQTJDTCxXQUEzQyxFQUF3RDtBQUNsRTtBQUNBLFFBQUlNLFlBQVksR0FBRyxFQUFuQixDQUZrRSxDQUdsRTs7QUFDQSxRQUFHSCxXQUFXLENBQUNJLE1BQVosS0FBdUIsQ0FBdkIsSUFBNEJGLFFBQVEsR0FBRyxDQUExQyxFQUE2QztBQUN6Q0MsTUFBQUEsWUFBWSxDQUFDRSxJQUFiLENBQWtCLEVBQWxCO0FBQ0EsYUFBT0YsWUFBUDtBQUNIOztBQUVELFFBQUlHLElBQUksR0FBR04sV0FBWDs7QUFDQSxXQUFPQyxRQUFRLEdBQUdDLFFBQVgsSUFBdUJJLElBQUksQ0FBQ0YsTUFBTCxHQUFjLENBQTVDLEVBQStDO0FBRTNDLFVBQUlHLFFBQVEsR0FBR0QsSUFBSSxDQUFDRixNQUFMLElBQWdCRixRQUFRLEdBQUdELFFBQTNCLElBQXdDLENBQXZEO0FBQ0EsVUFBSU8sT0FBTyxHQUFHRixJQUFJLENBQUNHLFNBQUwsQ0FBZUYsUUFBZixDQUFkO0FBQ0EsVUFBSVQsS0FBSyxHQUFHRyxRQUFRLEdBQUdKLFdBQVcsQ0FBQ1csT0FBRCxDQUFsQztBQUNBLFVBQUlFLEtBQUssR0FBR0YsT0FBWjtBQUNBLFVBQUlHLE9BQU8sR0FBRyxDQUFkO0FBRUEsVUFBSUMsVUFBVSxHQUFHLENBQWpCO0FBQ0EsVUFBSUMsVUFBVSxHQUFHLEVBQWpCLENBVDJDLENBVzNDOztBQUNBLGFBQU9mLEtBQUssR0FBR0ksUUFBUixJQUFvQlUsVUFBVSxLQUFLQyxVQUExQyxFQUFzRDtBQUNsRE4sUUFBQUEsUUFBUSxJQUFJTCxRQUFRLEdBQUdKLEtBQXZCO0FBQ0FTLFFBQUFBLFFBQVEsR0FBR0EsUUFBUSxHQUFHLENBQXRCO0FBQ0FDLFFBQUFBLE9BQU8sR0FBR0YsSUFBSSxDQUFDRyxTQUFMLENBQWVGLFFBQWYsQ0FBVjtBQUNBVCxRQUFBQSxLQUFLLEdBQUdHLFFBQVEsR0FBR0osV0FBVyxDQUFDVyxPQUFELENBQTlCO0FBQ0g7O0FBRURJLE1BQUFBLFVBQVUsR0FBRyxDQUFiLENBbkIyQyxDQXFCM0M7O0FBQ0EsYUFBT2QsS0FBSyxJQUFJSSxRQUFULElBQXFCVSxVQUFVLEtBQUtDLFVBQTNDLEVBQXVEO0FBQ25ELFlBQUlMLE9BQUosRUFBYTtBQUNULGNBQUlNLElBQUksR0FBRyxLQUFLeEMsYUFBTCxDQUFtQndDLElBQW5CLENBQXdCTixPQUF4QixDQUFYO0FBQ0FHLFVBQUFBLE9BQU8sR0FBR0csSUFBSSxHQUFHQSxJQUFJLENBQUMsQ0FBRCxDQUFKLENBQVFWLE1BQVgsR0FBb0IsQ0FBbEM7QUFDQU0sVUFBQUEsS0FBSyxHQUFHRixPQUFSO0FBQ0g7O0FBRURELFFBQUFBLFFBQVEsR0FBR0EsUUFBUSxHQUFHSSxPQUF0QjtBQUNBSCxRQUFBQSxPQUFPLEdBQUdGLElBQUksQ0FBQ0csU0FBTCxDQUFlRixRQUFmLENBQVY7QUFDQVQsUUFBQUEsS0FBSyxHQUFHRyxRQUFRLEdBQUdKLFdBQVcsQ0FBQ1csT0FBRCxDQUE5QjtBQUNIOztBQUVERCxNQUFBQSxRQUFRLElBQUlJLE9BQVo7O0FBQ0EsVUFBSUosUUFBUSxLQUFLLENBQWpCLEVBQW9CO0FBQ2hCQSxRQUFBQSxRQUFRLEdBQUcsQ0FBWDtBQUNBRyxRQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ0QsU0FBTixDQUFnQixDQUFoQixDQUFSO0FBQ0g7O0FBRUQsVUFBSU0sS0FBSyxHQUFHVCxJQUFJLENBQUNHLFNBQUwsQ0FBZSxDQUFmLEVBQWtCLElBQUlGLFFBQXRCLENBQVo7QUFBQSxVQUE2Q1MsTUFBN0MsQ0F4QzJDLENBMEMzQzs7QUFDQSxVQUFJLEtBQUtuQyxvQkFBVCxFQUErQjtBQUMzQixZQUFJLEtBQUtOLGVBQUwsQ0FBcUJZLElBQXJCLENBQTBCdUIsS0FBSyxJQUFJRixPQUFuQyxDQUFKLEVBQWlEO0FBQzdDUSxVQUFBQSxNQUFNLEdBQUcsS0FBS3hDLGlCQUFMLENBQXVCc0MsSUFBdkIsQ0FBNEJDLEtBQTVCLENBQVQ7QUFDQVIsVUFBQUEsUUFBUSxJQUFJUyxNQUFNLEdBQUdBLE1BQU0sQ0FBQyxDQUFELENBQU4sQ0FBVVosTUFBYixHQUFzQixDQUF4QztBQUNBLGNBQUlHLFFBQVEsS0FBSyxDQUFqQixFQUFvQkEsUUFBUSxHQUFHLENBQVg7QUFFcEJHLFVBQUFBLEtBQUssR0FBR0osSUFBSSxDQUFDRyxTQUFMLENBQWVGLFFBQWYsQ0FBUjtBQUNBUSxVQUFBQSxLQUFLLEdBQUdULElBQUksQ0FBQ0csU0FBTCxDQUFlLENBQWYsRUFBa0IsSUFBSUYsUUFBdEIsQ0FBUjtBQUNIO0FBQ0osT0FwRDBDLENBc0QzQztBQUNBOzs7QUFDQSxVQUFJLEtBQUs1QixnQkFBTCxDQUFzQlEsSUFBdEIsQ0FBMkJ1QixLQUEzQixDQUFKLEVBQXVDO0FBQ25DTSxRQUFBQSxNQUFNLEdBQUcsS0FBS3BDLGVBQUwsQ0FBcUJrQyxJQUFyQixDQUEwQkMsS0FBMUIsQ0FBVDs7QUFDQSxZQUFJQyxNQUFNLElBQUlELEtBQUssS0FBS0MsTUFBTSxDQUFDLENBQUQsQ0FBOUIsRUFBbUM7QUFDL0JULFVBQUFBLFFBQVEsSUFBSVMsTUFBTSxDQUFDLENBQUQsQ0FBTixDQUFVWixNQUF0QjtBQUNBTSxVQUFBQSxLQUFLLEdBQUdKLElBQUksQ0FBQ0csU0FBTCxDQUFlRixRQUFmLENBQVI7QUFDQVEsVUFBQUEsS0FBSyxHQUFHVCxJQUFJLENBQUNHLFNBQUwsQ0FBZSxDQUFmLEVBQWtCLElBQUlGLFFBQXRCLENBQVI7QUFDSDtBQUNKLE9BL0QwQyxDQWlFM0M7OztBQUNBLFVBQUksS0FBSzdCLGtCQUFMLENBQXdCUyxJQUF4QixDQUE2QnVCLEtBQTdCLENBQUosRUFBeUM7QUFDckNNLFFBQUFBLE1BQU0sR0FBRyxLQUFLdkMsaUJBQUwsQ0FBdUJxQyxJQUF2QixDQUE0QkMsS0FBNUIsQ0FBVDs7QUFDQSxZQUFJQyxNQUFNLElBQUlELEtBQUssS0FBS0MsTUFBTSxDQUFDLENBQUQsQ0FBOUIsRUFBbUM7QUFDL0JULFVBQUFBLFFBQVEsSUFBSVMsTUFBTSxDQUFDLENBQUQsQ0FBTixDQUFVWixNQUF0QjtBQUNBTSxVQUFBQSxLQUFLLEdBQUdKLElBQUksQ0FBQ0csU0FBTCxDQUFlRixRQUFmLENBQVI7QUFDQVEsVUFBQUEsS0FBSyxHQUFHVCxJQUFJLENBQUNHLFNBQUwsQ0FBZSxDQUFmLEVBQWtCLElBQUlGLFFBQXRCLENBQVI7QUFDSDtBQUNKLE9BekUwQyxDQTJFM0M7OztBQUNBLFVBQUlKLFlBQVksQ0FBQ0MsTUFBYixLQUF3QixDQUE1QixFQUErQjtBQUMzQkQsUUFBQUEsWUFBWSxDQUFDRSxJQUFiLENBQWtCVSxLQUFsQjtBQUNILE9BRkQsTUFHSztBQUNEQSxRQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ0UsUUFBTixFQUFSOztBQUNBLFlBQUlGLEtBQUssQ0FBQ1gsTUFBTixHQUFlLENBQW5CLEVBQXNCO0FBQ2xCRCxVQUFBQSxZQUFZLENBQUNFLElBQWIsQ0FBa0JVLEtBQWxCO0FBQ0g7QUFDSjs7QUFDRFQsTUFBQUEsSUFBSSxHQUFHSSxLQUFLLElBQUlGLE9BQWhCO0FBQ0FQLE1BQUFBLFFBQVEsR0FBR0osV0FBVyxDQUFDUyxJQUFELENBQXRCO0FBQ0g7O0FBRUQsUUFBSUgsWUFBWSxDQUFDQyxNQUFiLEtBQXdCLENBQTVCLEVBQStCO0FBQzNCRCxNQUFBQSxZQUFZLENBQUNFLElBQWIsQ0FBa0JDLElBQWxCO0FBQ0gsS0FGRCxNQUdLO0FBQ0RBLE1BQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDVyxRQUFMLEVBQVA7O0FBQ0EsVUFBSVgsSUFBSSxDQUFDRixNQUFMLEdBQWMsQ0FBbEIsRUFBcUI7QUFDakJELFFBQUFBLFlBQVksQ0FBQ0UsSUFBYixDQUFrQkMsSUFBbEI7QUFDSDtBQUNKOztBQUNELFdBQU9ILFlBQVA7QUFDSDtBQXhKVyxDQUFoQjtBQTJKQWUsRUFBRSxDQUFDL0MsU0FBSCxHQUFlZ0QsTUFBTSxDQUFDQyxPQUFQLEdBQWlCakQsU0FBaEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuIENvcHlyaWdodCAoYykgMjAxMy0yMDE2IENodWtvbmcgVGVjaG5vbG9naWVzIEluYy5cbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAxOCBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcbiBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXG4gdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxuXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbiBUSEUgU09GVFdBUkUuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IGpzIGZyb20gJy4uL3BsYXRmb3JtL2pzJ1xuXG4vLyBEcmF3IHRleHQgdGhlIHRleHRCYXNlbGluZSByYXRpbyAoQ2FuIGFkanVzdCB0aGUgYXBwcm9wcmlhdGUgYmFzZWxpbmUgcmF0aW8gYmFzZWQgb24gdGhlIHBsYXRmb3JtKVxubGV0IF9CQVNFTElORV9SQVRJTyA9IDAuMjY7XG5pZiAoQ0NfUlVOVElNRSkge1xuICAgIF9CQVNFTElORV9SQVRJTyA9IC0wLjA1O1xufVxuXG5jb25zdCBNQVhfQ0FDSEVfU0laRSA9IDEwMDtcblxubGV0IHBvb2wgPSBuZXcganMuUG9vbCgyKTtcbnBvb2wuZ2V0ID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBub2RlID0gdGhpcy5fZ2V0KCkgfHwge1xuICAgICAgICBrZXk6IG51bGwsXG4gICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICBwcmV2OiBudWxsLFxuICAgICAgICBuZXh0OiBudWxsXG4gICAgfTtcblxuICAgIHJldHVybiBub2RlO1xufTtcblxuZnVuY3Rpb24gTFJVQ2FjaGUoc2l6ZSkge1xuICAgIHRoaXMuY291bnQgPSAwO1xuICAgIHRoaXMubGltaXQgPSBzaXplO1xuICAgIHRoaXMuZGF0YXMgPSB7fTtcbiAgICB0aGlzLmhlYWQgPSBudWxsO1xuICAgIHRoaXMudGFpbCA9IG51bGw7XG59XG5cbkxSVUNhY2hlLnByb3RvdHlwZS5tb3ZlVG9IZWFkID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICBub2RlLm5leHQgPSB0aGlzLmhlYWQ7XG4gICAgbm9kZS5wcmV2ID0gbnVsbDtcbiAgICBpZiAodGhpcy5oZWFkICE9PSBudWxsKSBcbiAgICAgICAgdGhpcy5oZWFkLnByZXYgPSBub2RlO1xuICAgIHRoaXMuaGVhZCA9IG5vZGU7XG4gICAgaWYgKHRoaXMudGFpbCA9PT0gbnVsbCkgXG4gICAgICAgIHRoaXMudGFpbCA9IG5vZGU7XG4gICAgdGhpcy5jb3VudCsrO1xuICAgIHRoaXMuZGF0YXNbbm9kZS5rZXldID0gbm9kZTtcbn1cblxuTFJVQ2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7XG4gICAgY29uc3Qgbm9kZSA9IHBvb2wuZ2V0KCk7XG4gICAgbm9kZS5rZXkgPSBrZXk7XG4gICAgbm9kZS52YWx1ZSA9IHZhbHVlO1xuICAgIFxuICAgIGlmICh0aGlzLmNvdW50ID49IHRoaXMubGltaXQpIHtcbiAgICAgICAgbGV0IGRpc2NhcmQgPSB0aGlzLnRhaWw7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmRhdGFzW2Rpc2NhcmQua2V5XTtcbiAgICAgICAgdGhpcy5jb3VudC0tO1xuICAgICAgICB0aGlzLnRhaWwgPSBkaXNjYXJkLnByZXY7XG4gICAgICAgIHRoaXMudGFpbC5uZXh0ID0gbnVsbDtcbiAgICAgICAgZGlzY2FyZC5wcmV2ID0gbnVsbDtcbiAgICAgICAgZGlzY2FyZC5uZXh0ID0gbnVsbDtcbiAgICAgICAgcG9vbC5wdXQoZGlzY2FyZCk7XG4gICAgfVxuICAgIHRoaXMubW92ZVRvSGVhZChub2RlKTtcbn1cblxuTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChub2RlKSB7XG4gICAgaWYgKG5vZGUucHJldiAhPT0gbnVsbCkge1xuICAgICAgICBub2RlLnByZXYubmV4dCA9IG5vZGUubmV4dDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmhlYWQgPSBub2RlLm5leHQ7XG4gICAgfVxuICAgIGlmIChub2RlLm5leHQgIT09IG51bGwpIHtcbiAgICAgICAgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXY7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50YWlsID0gbm9kZS5wcmV2O1xuICAgIH1cbiAgICBkZWxldGUgdGhpcy5kYXRhc1tub2RlLmtleV07XG4gICAgdGhpcy5jb3VudC0tO1xufVxuXG5MUlVDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmRhdGFzW2tleV07XG4gICAgaWYgKG5vZGUpIHtcbiAgICAgICAgdGhpcy5yZW1vdmUobm9kZSk7XG4gICAgICAgIHRoaXMubW92ZVRvSGVhZChub2RlKTtcbiAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5MUlVDYWNoZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5jb3VudCA9IDA7XG4gICAgdGhpcy5kYXRhcyA9IHt9O1xuICAgIHRoaXMuaGVhZCA9IG51bGw7XG4gICAgdGhpcy50YWlsID0gbnVsbDtcbn1cblxuTFJVQ2FjaGUucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgICByZXR1cm4gISF0aGlzLmRhdGFzW2tleV07XG59XG5cbkxSVUNhY2hlLnByb3RvdHlwZS5kZWxldGUgPSBmdW5jdGlvbiAoa2V5KSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuZGF0YXNba2V5XTtcbiAgICB0aGlzLnJlbW92ZShub2RlKTtcbn1cblxubGV0IG1lYXN1cmVDYWNoZSA9IG5ldyBMUlVDYWNoZShNQVhfQ0FDSEVfU0laRSk7XG5cbnZhciB0ZXh0VXRpbHMgPSB7XG5cbiAgICBCQVNFTElORV9SQVRJTzogX0JBU0VMSU5FX1JBVElPLFxuICAgIE1JRERMRV9SQVRJTzogKF9CQVNFTElORV9SQVRJTyArIDEpIC8gMiAtIF9CQVNFTElORV9SQVRJTyxcblxuICAgIGxhYmVsX3dvcmRSZXggOiAvKFthLXpBLVowLTnDhMOWw5zDpMO2w7zDn8Opw6jDp8Ogw7nDqsOiw67DtMO70LAt0Y/QkC3Qr9CB0ZFdK3xcXFMpLyxcbiAgICBsYWJlbF9zeW1ib2xSZXggOiAvXlshLC46Oyd9XFxdJVxcPz7jgIHigJjigJzjgIvvvJ/jgILvvIzvvIFdLyxcbiAgICBsYWJlbF9sYXN0V29yZFJleCA6IC8oW2EtekEtWjAtOcOEw5bDnMOkw7bDvMOfw6nDqMOnw6DDucOqw6LDrsO0w7vQsMOtw6zDjcOMw6/DgcOAw6HDoMOJw4jDksOTw7LDs8WQxZHDmcOaxbDDusWxw7HDkcOmw4bFk8WSw4PDgsOjw5TDtcSbxaHEjcWZxb7DvcOhw63DqcOzw7rFr8WlxI/FiMSaxaDEjMWYxb3DgcONw4nDk8OaxaTFvMW6xZvDs8WExYLEmcSHxIXFu8W5xZrDk8WDxYHEmMSGxIQt0Y/QkC3Qr9CB0ZFdK3xcXFMpJC8sXG4gICAgbGFiZWxfbGFzdEVuZ2xpc2ggOiAvW2EtekEtWjAtOcOEw5bDnMOkw7bDvMOfw6nDqMOnw6DDucOqw6LDrsO0w7vQsMOtw6zDjcOMw6/DgcOAw6HDoMOJw4jDksOTw7LDs8WQxZHDmcOaxbDDusWxw7HDkcOmw4bFk8WSw4PDgsOjw5TDtcSbxaHEjcWZxb7DvcOhw63DqcOzw7rFr8WlxI/FiMSaxaDEjMWYxb3DgcONw4nDk8OaxaTFvMW6xZvDs8WExYLEmcSHxIXFu8W5xZrDk8WDxYHEmMSGxIQt0Y/QkC3Qr9CB0ZFdKyQvLFxuICAgIGxhYmVsX2ZpcnN0RW5nbGlzaCA6IC9eW2EtekEtWjAtOcOEw5bDnMOkw7bDvMOfw6nDqMOnw6DDucOqw6LDrsO0w7vQsMOtw6zDjcOMw6/DgcOAw6HDoMOJw4jDksOTw7LDs8WQxZHDmcOaxbDDusWxw7HDkcOmw4bFk8WSw4PDgsOjw5TDtcSbxaHEjcWZxb7DvcOhw63DqcOzw7rFr8WlxI/FiMSaxaDEjMWYxb3DgcONw4nDk8OaxaTFvMW6xZvDs8WExYLEmcSHxIXFu8W5xZrDk8WDxYHEmMSGxIQt0Y/QkC3Qr9CB0ZFdLyxcbiAgICBsYWJlbF9maXJzdEVtb2ppIDogL15bXFx1RDgzQ1xcdURGMDAtXFx1REZGRlxcdURDMDAtXFx1REU0Rl0vLFxuICAgIGxhYmVsX2xhc3RFbW9qaSA6IC8oW1xcdURGMDAtXFx1REZGRlxcdURDMDAtXFx1REU0Rl0rfFxcUykkLyxcbiAgICBsYWJlbF93cmFwaW5zcGVjdGlvbiA6IHRydWUsXG5cbiAgICBfX0NISU5FU0VfUkVHOiAvXltcXHU0RTAwLVxcdTlGRkZcXHUzNDAwLVxcdTRERkZdKyQvLFxuICAgIF9fSkFQQU5FU0VfUkVHOiAvW1xcdTMwMDAtXFx1MzAzRl18W1xcdTMwNDAtXFx1MzA5Rl18W1xcdTMwQTAtXFx1MzBGRl18W1xcdUZGMDAtXFx1RkZFRl18W1xcdTRFMDAtXFx1OUZBRl18W1xcdTI2MDUtXFx1MjYwNl18W1xcdTIxOTAtXFx1MjE5NV18XFx1MjAzQi9nLFxuICAgIF9fS09SRUFOX1JFRzogL15bXFx1MTEwMC1cXHUxMUZGXXxbXFx1MzEzMC1cXHUzMThGXXxbXFx1QTk2MC1cXHVBOTdGXXxbXFx1QUMwMC1cXHVEN0FGXXxbXFx1RDdCMC1cXHVEN0ZGXSskLyxcblxuICAgIGlzVW5pY29kZUNKSzogZnVuY3Rpb24oY2gpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX19DSElORVNFX1JFRy50ZXN0KGNoKSB8fCB0aGlzLl9fSkFQQU5FU0VfUkVHLnRlc3QoY2gpIHx8IHRoaXMuX19LT1JFQU5fUkVHLnRlc3QoY2gpO1xuICAgIH0sXG5cbiAgICAvL0NoZWNraW5nIHdoZXRoZXIgdGhlIGNoYXJhY3RlciBpcyBhIHdoaXRlc3BhY2VcbiAgICBpc1VuaWNvZGVTcGFjZTogZnVuY3Rpb24oY2gpIHtcbiAgICAgICAgY2ggPSBjaC5jaGFyQ29kZUF0KDApO1xuICAgICAgICByZXR1cm4gKChjaCA+PSA5ICYmIGNoIDw9IDEzKSB8fCBjaCA9PT0gMzIgfHwgY2ggPT09IDEzMyB8fCBjaCA9PT0gMTYwIHx8IGNoID09PSA1NzYwIHx8IChjaCA+PSA4MTkyICYmIGNoIDw9IDgyMDIpIHx8IGNoID09PSA4MjMyIHx8IGNoID09PSA4MjMzIHx8IGNoID09PSA4MjM5IHx8IGNoID09PSA4Mjg3IHx8IGNoID09PSAxMjI4OCk7XG4gICAgfSxcblxuICAgIHNhZmVNZWFzdXJlVGV4dDogZnVuY3Rpb24gKGN0eCwgc3RyaW5nLCBkZXNjKSB7XG4gICAgICAgIGxldCBmb250ID0gZGVzYyB8fCBjdHguZm9udDtcbiAgICAgICAgbGV0IGtleSA9IGZvbnQgKyBcIlxcdUQ4M0NcXHVERkFFXCIgKyBzdHJpbmc7XG4gICAgICAgIGxldCBjYWNoZSA9IG1lYXN1cmVDYWNoZS5nZXQoa2V5KTtcbiAgICAgICAgaWYgKGNhY2hlICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gY2FjaGU7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbWV0cmljID0gY3R4Lm1lYXN1cmVUZXh0KHN0cmluZyk7XG4gICAgICAgIGxldCB3aWR0aCA9IG1ldHJpYyAmJiBtZXRyaWMud2lkdGggfHwgMDtcbiAgICAgICAgbWVhc3VyZUNhY2hlLnB1dChrZXksIHdpZHRoKTtcblxuICAgICAgICByZXR1cm4gd2lkdGg7XG4gICAgfSxcblxuICAgIGZyYWdtZW50VGV4dDogZnVuY3Rpb24gKHN0cmluZ1Rva2VuLCBhbGxXaWR0aCwgbWF4V2lkdGgsIG1lYXN1cmVUZXh0KSB7XG4gICAgICAgIC8vY2hlY2sgdGhlIGZpcnN0IGNoYXJhY3RlclxuICAgICAgICB2YXIgd3JhcHBlZFdvcmRzID0gW107XG4gICAgICAgIC8vZmFzdCByZXR1cm4gaWYgc3RyQXJyIGlzIGVtcHR5XG4gICAgICAgIGlmKHN0cmluZ1Rva2VuLmxlbmd0aCA9PT0gMCB8fCBtYXhXaWR0aCA8IDApIHtcbiAgICAgICAgICAgIHdyYXBwZWRXb3Jkcy5wdXNoKCcnKTtcbiAgICAgICAgICAgIHJldHVybiB3cmFwcGVkV29yZHM7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgdGV4dCA9IHN0cmluZ1Rva2VuO1xuICAgICAgICB3aGlsZSAoYWxsV2lkdGggPiBtYXhXaWR0aCAmJiB0ZXh0Lmxlbmd0aCA+IDEpIHtcblxuICAgICAgICAgICAgdmFyIGZ1enp5TGVuID0gdGV4dC5sZW5ndGggKiAoIG1heFdpZHRoIC8gYWxsV2lkdGggKSB8IDA7XG4gICAgICAgICAgICB2YXIgdG1wVGV4dCA9IHRleHQuc3Vic3RyaW5nKGZ1enp5TGVuKTtcbiAgICAgICAgICAgIHZhciB3aWR0aCA9IGFsbFdpZHRoIC0gbWVhc3VyZVRleHQodG1wVGV4dCk7XG4gICAgICAgICAgICB2YXIgc0xpbmUgPSB0bXBUZXh0O1xuICAgICAgICAgICAgdmFyIHB1c2hOdW0gPSAwO1xuXG4gICAgICAgICAgICB2YXIgY2hlY2tXaGlsZSA9IDA7XG4gICAgICAgICAgICB2YXIgY2hlY2tDb3VudCA9IDEwO1xuXG4gICAgICAgICAgICAvL0V4Y2VlZGVkIHRoZSBzaXplXG4gICAgICAgICAgICB3aGlsZSAod2lkdGggPiBtYXhXaWR0aCAmJiBjaGVja1doaWxlKysgPCBjaGVja0NvdW50KSB7XG4gICAgICAgICAgICAgICAgZnV6enlMZW4gKj0gbWF4V2lkdGggLyB3aWR0aDtcbiAgICAgICAgICAgICAgICBmdXp6eUxlbiA9IGZ1enp5TGVuIHwgMDtcbiAgICAgICAgICAgICAgICB0bXBUZXh0ID0gdGV4dC5zdWJzdHJpbmcoZnV6enlMZW4pO1xuICAgICAgICAgICAgICAgIHdpZHRoID0gYWxsV2lkdGggLSBtZWFzdXJlVGV4dCh0bXBUZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2hlY2tXaGlsZSA9IDA7XG5cbiAgICAgICAgICAgIC8vRmluZCB0aGUgdHJ1bmNhdGlvbiBwb2ludFxuICAgICAgICAgICAgd2hpbGUgKHdpZHRoIDw9IG1heFdpZHRoICYmIGNoZWNrV2hpbGUrKyA8IGNoZWNrQ291bnQpIHtcbiAgICAgICAgICAgICAgICBpZiAodG1wVGV4dCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZXhlYyA9IHRoaXMubGFiZWxfd29yZFJleC5leGVjKHRtcFRleHQpO1xuICAgICAgICAgICAgICAgICAgICBwdXNoTnVtID0gZXhlYyA/IGV4ZWNbMF0ubGVuZ3RoIDogMTtcbiAgICAgICAgICAgICAgICAgICAgc0xpbmUgPSB0bXBUZXh0O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZ1enp5TGVuID0gZnV6enlMZW4gKyBwdXNoTnVtO1xuICAgICAgICAgICAgICAgIHRtcFRleHQgPSB0ZXh0LnN1YnN0cmluZyhmdXp6eUxlbik7XG4gICAgICAgICAgICAgICAgd2lkdGggPSBhbGxXaWR0aCAtIG1lYXN1cmVUZXh0KHRtcFRleHQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmdXp6eUxlbiAtPSBwdXNoTnVtO1xuICAgICAgICAgICAgaWYgKGZ1enp5TGVuID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZnV6enlMZW4gPSAxO1xuICAgICAgICAgICAgICAgIHNMaW5lID0gc0xpbmUuc3Vic3RyaW5nKDEpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgc1RleHQgPSB0ZXh0LnN1YnN0cmluZygwLCAwICsgZnV6enlMZW4pLCByZXN1bHQ7XG5cbiAgICAgICAgICAgIC8vc3ltYm9sIGluIHRoZSBmaXJzdFxuICAgICAgICAgICAgaWYgKHRoaXMubGFiZWxfd3JhcGluc3BlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYWJlbF9zeW1ib2xSZXgudGVzdChzTGluZSB8fCB0bXBUZXh0KSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLmxhYmVsX2xhc3RXb3JkUmV4LmV4ZWMoc1RleHQpO1xuICAgICAgICAgICAgICAgICAgICBmdXp6eUxlbiAtPSByZXN1bHQgPyByZXN1bHRbMF0ubGVuZ3RoIDogMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZ1enp5TGVuID09PSAwKSBmdXp6eUxlbiA9IDE7XG5cbiAgICAgICAgICAgICAgICAgICAgc0xpbmUgPSB0ZXh0LnN1YnN0cmluZyhmdXp6eUxlbik7XG4gICAgICAgICAgICAgICAgICAgIHNUZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgMCArIGZ1enp5TGVuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFRvIGp1ZGdlIHdoZXRoZXIgYSBFbW9qaSB3b3JkcyBhcmUgdHJ1bmNhdGVkXG4gICAgICAgICAgICAvLyB0b2RvIFNvbWUgRW1vamkgYXJlIG5vdCB3ZWxsIGFkYXB0ZWQsIHN1Y2ggYXMg8J+alyBhbmQg8J+HqPCfh7NcbiAgICAgICAgICAgIGlmICh0aGlzLmxhYmVsX2ZpcnN0RW1vamkudGVzdChzTGluZSkpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLmxhYmVsX2xhc3RFbW9qaS5leGVjKHNUZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICYmIHNUZXh0ICE9PSByZXN1bHRbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZnV6enlMZW4gLT0gcmVzdWx0WzBdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgc0xpbmUgPSB0ZXh0LnN1YnN0cmluZyhmdXp6eUxlbik7XG4gICAgICAgICAgICAgICAgICAgIHNUZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgMCArIGZ1enp5TGVuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vVG8ganVkZ2Ugd2hldGhlciBhIEVuZ2xpc2ggd29yZHMgYXJlIHRydW5jYXRlZFxuICAgICAgICAgICAgaWYgKHRoaXMubGFiZWxfZmlyc3RFbmdsaXNoLnRlc3Qoc0xpbmUpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5sYWJlbF9sYXN0RW5nbGlzaC5leGVjKHNUZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICYmIHNUZXh0ICE9PSByZXN1bHRbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZnV6enlMZW4gLT0gcmVzdWx0WzBdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgc0xpbmUgPSB0ZXh0LnN1YnN0cmluZyhmdXp6eUxlbik7XG4gICAgICAgICAgICAgICAgICAgIHNUZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgMCArIGZ1enp5TGVuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFRoZSBmaXJzdCBsaW5lIEFuZCBkbyBub3Qgd3JhcCBzaG91bGQgbm90IHJlbW92ZSB0aGUgc3BhY2VcbiAgICAgICAgICAgIGlmICh3cmFwcGVkV29yZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgd3JhcHBlZFdvcmRzLnB1c2goc1RleHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc1RleHQgPSBzVGV4dC50cmltTGVmdCgpO1xuICAgICAgICAgICAgICAgIGlmIChzVGV4dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHdyYXBwZWRXb3Jkcy5wdXNoKHNUZXh0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0ZXh0ID0gc0xpbmUgfHwgdG1wVGV4dDtcbiAgICAgICAgICAgIGFsbFdpZHRoID0gbWVhc3VyZVRleHQodGV4dCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAod3JhcHBlZFdvcmRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgd3JhcHBlZFdvcmRzLnB1c2godGV4dCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0ZXh0ID0gdGV4dC50cmltTGVmdCgpO1xuICAgICAgICAgICAgaWYgKHRleHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHdyYXBwZWRXb3Jkcy5wdXNoKHRleHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB3cmFwcGVkV29yZHM7XG4gICAgfSxcbn07XG5cbmNjLnRleHRVdGlscyA9IG1vZHVsZS5leHBvcnRzID0gdGV4dFV0aWxzO1xuIl19