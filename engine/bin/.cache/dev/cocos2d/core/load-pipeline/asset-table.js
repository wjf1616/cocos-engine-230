
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/load-pipeline/asset-table.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2013-2016 Chukong Technologies Inc.
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
 worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
 not use Cocos Creator software for developing other software or tools that's
 used for developing games. You are not granted to publish, distribute,
 sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var pushToMap = require('../utils/misc').pushToMap;

var js = require('../platform/js');

function Entry(uuid, type) {
  this.uuid = uuid;
  this.type = type;
}
/*
 * !#en AssetTable is used to find asset's uuid by url.
 * !#zh AssetTable 用于查找资源的 uuid 和 url。
 * @class AssetTable
 *
 */


function AssetTable() {
  this._pathToUuid = js.createMap(true);
}

function isMatchByWord(path, test) {
  if (path.length > test.length) {
    var nextAscii = path.charCodeAt(test.length);
    return nextAscii === 46 || nextAscii === 47; // '.' or '/'
  }

  return true;
}

var proto = AssetTable.prototype;

proto.getUuid = function (path, type) {
  path = cc.url.normalize(path);
  var item = this._pathToUuid[path];

  if (item) {
    if (Array.isArray(item)) {
      if (type) {
        for (var i = 0; i < item.length; i++) {
          var entry = item[i];

          if (js.isChildClassOf(entry.type, type)) {
            return entry.uuid;
          }
        } // not found


        if (CC_DEBUG && js.isChildClassOf(type, cc.SpriteFrame)) {
          for (var _i = 0; _i < item.length; _i++) {
            var _entry = item[_i];

            if (js.isChildClassOf(_entry.type, cc.SpriteAtlas)) {
              // not support sprite frame in atlas
              cc.errorID(4932, path);
              break;
            }
          }
        }
      } else {
        return item[0].uuid;
      }
    } else if (!type || js.isChildClassOf(item.type, type)) {
      return item.uuid;
    } else if (CC_DEBUG && js.isChildClassOf(type, cc.SpriteFrame) && js.isChildClassOf(item.type, cc.SpriteAtlas)) {
      // not support sprite frame in atlas
      cc.errorID(4932, path);
    }
  }

  return '';
};

proto.getUuidArray = function (path, type, out_urls) {
  path = cc.url.normalize(path);

  if (path[path.length - 1] === '/') {
    path = path.slice(0, -1);
  }

  var path2uuid = this._pathToUuid;
  var uuids = [];
  var isChildClassOf = js.isChildClassOf;

  var _foundAtlasUrl;

  for (var p in path2uuid) {
    if (p.startsWith(path) && isMatchByWord(p, path) || !path) {
      var item = path2uuid[p];

      if (Array.isArray(item)) {
        for (var i = 0; i < item.length; i++) {
          var entry = item[i];

          if (!type || isChildClassOf(entry.type, type)) {
            uuids.push(entry.uuid);

            if (out_urls) {
              out_urls.push(p);
            }
          } else if (CC_DEBUG && entry.type === cc.SpriteAtlas) {
            _foundAtlasUrl = p;
          }
        }
      } else {
        if (!type || isChildClassOf(item.type, type)) {
          uuids.push(item.uuid);

          if (out_urls) {
            out_urls.push(p);
          }
        } else if (CC_DEBUG && item.type === cc.SpriteAtlas) {
          _foundAtlasUrl = p;
        }
      }
    }
  }

  if (CC_DEBUG && uuids.length === 0 && _foundAtlasUrl && js.isChildClassOf(type, cc.SpriteFrame)) {
    // not support sprite frame in atlas
    cc.errorID(4932, _foundAtlasUrl);
  }

  return uuids;
}; // /**
//  * !#en Returns all asset paths in the table.
//  * !#zh 返回表中的所有资源路径。
//  * @method getAllPaths
//  * @return {string[]}
//  */
// proto.getAllPaths = function () {
//     return Object.keys(this._pathToUuid);
// };

/**
 * !#en TODO
 * !#zh 以路径为 key，uuid 为值添加到表中。
 * @method add
 * @param {String} path - the path to load, should NOT include filename extensions.
 * @param {String} uuid
 * @param {Function} type
 * @param {Boolean} isMainAsset
 * @private
 */


proto.add = function (path, uuid, type, isMainAsset) {
  // remove extname
  // (can not use path.slice because length of extname maybe 0)
  path = path.substring(0, path.length - cc.path.extname(path).length);
  var newEntry = new Entry(uuid, type);
  pushToMap(this._pathToUuid, path, newEntry, isMainAsset);
};

proto._getInfo_DEBUG = CC_DEBUG && function (uuid, out_info) {
  var path2uuid = this._pathToUuid;
  var paths = Object.keys(path2uuid);

  for (var p = 0; p < paths.length; ++p) {
    var path = paths[p];
    var item = path2uuid[path];

    if (Array.isArray(item)) {
      for (var i = 0; i < item.length; i++) {
        var entry = item[i];

        if (entry.uuid === uuid) {
          out_info.path = path;
          out_info.type = entry.type;
          return true;
        }
      }
    } else if (item.uuid === uuid) {
      out_info.path = path;
      out_info.type = item.type;
      return true;
    }
  }

  return false;
};

proto.reset = function () {
  this._pathToUuid = js.createMap(true);
};

module.exports = AssetTable;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0LXRhYmxlLmpzIl0sIm5hbWVzIjpbInB1c2hUb01hcCIsInJlcXVpcmUiLCJqcyIsIkVudHJ5IiwidXVpZCIsInR5cGUiLCJBc3NldFRhYmxlIiwiX3BhdGhUb1V1aWQiLCJjcmVhdGVNYXAiLCJpc01hdGNoQnlXb3JkIiwicGF0aCIsInRlc3QiLCJsZW5ndGgiLCJuZXh0QXNjaWkiLCJjaGFyQ29kZUF0IiwicHJvdG8iLCJwcm90b3R5cGUiLCJnZXRVdWlkIiwiY2MiLCJ1cmwiLCJub3JtYWxpemUiLCJpdGVtIiwiQXJyYXkiLCJpc0FycmF5IiwiaSIsImVudHJ5IiwiaXNDaGlsZENsYXNzT2YiLCJDQ19ERUJVRyIsIlNwcml0ZUZyYW1lIiwiU3ByaXRlQXRsYXMiLCJlcnJvcklEIiwiZ2V0VXVpZEFycmF5Iiwib3V0X3VybHMiLCJzbGljZSIsInBhdGgydXVpZCIsInV1aWRzIiwiX2ZvdW5kQXRsYXNVcmwiLCJwIiwic3RhcnRzV2l0aCIsInB1c2giLCJhZGQiLCJpc01haW5Bc3NldCIsInN1YnN0cmluZyIsImV4dG5hbWUiLCJuZXdFbnRyeSIsIl9nZXRJbmZvX0RFQlVHIiwib3V0X2luZm8iLCJwYXRocyIsIk9iamVjdCIsImtleXMiLCJyZXNldCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTBCQSxJQUFJQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxlQUFELENBQVAsQ0FBeUJELFNBQXpDOztBQUNBLElBQUlFLEVBQUUsR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBQWhCOztBQUVBLFNBQVNFLEtBQVQsQ0FBZ0JDLElBQWhCLEVBQXNCQyxJQUF0QixFQUE0QjtBQUN4QixPQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDQSxPQUFLQyxJQUFMLEdBQVlBLElBQVo7QUFDSDtBQUVEOzs7Ozs7OztBQU9BLFNBQVNDLFVBQVQsR0FBdUI7QUFDbkIsT0FBS0MsV0FB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QUFRLENBQUNwQyxJQUFULEdBQWdCQSxJQUFoQjtBQUNBb0MsVUFBQUEsUUFBUSxDQUFDekMsSUFBVCxHQUFnQm9CLEtBQUssQ0FBQ3BCLElBQXRCO0FBQ0EsaUJBQU8sSUFBUDtBQUNIO0FBQ0o7QUFDSixLQVRELE1BVUssSUFBSWdCLElBQUksQ0FBQ2pCLElBQUwsS0FBY0EsSUFBbEIsRUFBd0I7QUFDekIwQyxNQUFBQSxRQUFRLENBQUNwQyxJQUFULEdBQWdCQSxJQUFoQjtBQUNBb0MsTUFBQUEsUUFBUSxDQUFDekMsSUFBVCxHQUFnQmdCLElBQUksQ0FBQ2hCLElBQXJCO0FBQ0EsYUFBTyxJQUFQO0FBQ0g7QUFDSjs7QUFDRCxTQUFPLEtBQVA7QUFDSCxDQXZCRDs7QUF5QkFVLEtBQUssQ0FBQ21DLEtBQU4sR0FBYyxZQUFZO0FBQ3RCLE9BQUszQyxXQUFMLEdBQW1CTCxFQUFFLENBQUNNLFNBQUgsQ0FBYSxJQUFiLENBQW5CO0FBQ0gsQ0FGRDs7QUFLQTJDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjlDLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTMtMjAxNiBDaHVrb25nIFRlY2hub2xvZ2llcyBJbmMuXG4gQ29weXJpZ2h0IChjKSAyMDE3LTIwMTggWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXG5cbiBodHRwczovL3d3dy5jb2Nvcy5jb20vXG5cbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXG4gd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXG4gbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xuIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcbiBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cblxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cblxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gVEhFIFNPRlRXQVJFLlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbnZhciBwdXNoVG9NYXAgPSByZXF1aXJlKCcuLi91dGlscy9taXNjJykucHVzaFRvTWFwO1xudmFyIGpzID0gcmVxdWlyZSgnLi4vcGxhdGZvcm0vanMnKTtcblxuZnVuY3Rpb24gRW50cnkgKHV1aWQsIHR5cGUpIHtcbiAgICB0aGlzLnV1aWQgPSB1dWlkO1xuICAgIHRoaXMudHlwZSA9IHR5cGU7XG59XG5cbi8qXG4gKiAhI2VuIEFzc2V0VGFibGUgaXMgdXNlZCB0byBmaW5kIGFzc2V0J3MgdXVpZCBieSB1cmwuXG4gKiAhI3poIEFzc2V0VGFibGUg55So5LqO5p+l5om+6LWE5rqQ55qEIHV1aWQg5ZKMIHVybOOAglxuICogQGNsYXNzIEFzc2V0VGFibGVcbiAqXG4gKi9cblxuZnVuY3Rpb24gQXNzZXRUYWJsZSAoKSB7XG4gICAgdGhpcy5fcGF0aFRvVXVpZCA9IGpzLmNyZWF0ZU1hcCh0cnVlKTtcbn1cblxuZnVuY3Rpb24gaXNNYXRjaEJ5V29yZCAocGF0aCwgdGVzdCkge1xuICAgIGlmIChwYXRoLmxlbmd0aCA+IHRlc3QubGVuZ3RoKSB7XG4gICAgICAgIHZhciBuZXh0QXNjaWkgPSBwYXRoLmNoYXJDb2RlQXQodGVzdC5sZW5ndGgpO1xuICAgICAgICByZXR1cm4gKG5leHRBc2NpaSA9PT0gNDYgfHwgbmV4dEFzY2lpID09PSA0Nyk7IC8vICcuJyBvciAnLydcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbnZhciBwcm90byA9IEFzc2V0VGFibGUucHJvdG90eXBlO1xuXG5wcm90by5nZXRVdWlkID0gZnVuY3Rpb24gKHBhdGgsIHR5cGUpIHtcbiAgICBwYXRoID0gY2MudXJsLm5vcm1hbGl6ZShwYXRoKTtcbiAgICB2YXIgaXRlbSA9IHRoaXMuX3BhdGhUb1V1aWRbcGF0aF07XG4gICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHtcbiAgICAgICAgICAgIGlmICh0eXBlKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbnRyeSA9IGl0ZW1baV07XG4gICAgICAgICAgICAgICAgICAgIGlmIChqcy5pc0NoaWxkQ2xhc3NPZihlbnRyeS50eXBlLCB0eXBlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5LnV1aWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gbm90IGZvdW5kXG4gICAgICAgICAgICAgICAgaWYgKENDX0RFQlVHICYmIGpzLmlzQ2hpbGRDbGFzc09mKHR5cGUsIGNjLlNwcml0ZUZyYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbnRyeSA9IGl0ZW1baV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoanMuaXNDaGlsZENsYXNzT2YoZW50cnkudHlwZSwgY2MuU3ByaXRlQXRsYXMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm90IHN1cHBvcnQgc3ByaXRlIGZyYW1lIGluIGF0bGFzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2MuZXJyb3JJRCg0OTMyLCBwYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBpdGVtWzBdLnV1aWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoIXR5cGUgfHwganMuaXNDaGlsZENsYXNzT2YoaXRlbS50eXBlLCB0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGl0ZW0udXVpZDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChDQ19ERUJVRyAmJiBqcy5pc0NoaWxkQ2xhc3NPZih0eXBlLCBjYy5TcHJpdGVGcmFtZSkgJiYganMuaXNDaGlsZENsYXNzT2YoaXRlbS50eXBlLCBjYy5TcHJpdGVBdGxhcykpIHtcbiAgICAgICAgICAgIC8vIG5vdCBzdXBwb3J0IHNwcml0ZSBmcmFtZSBpbiBhdGxhc1xuICAgICAgICAgICAgY2MuZXJyb3JJRCg0OTMyLCBwYXRoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gJyc7XG59O1xuXG5wcm90by5nZXRVdWlkQXJyYXkgPSBmdW5jdGlvbiAocGF0aCwgdHlwZSwgb3V0X3VybHMpIHtcbiAgICBwYXRoID0gY2MudXJsLm5vcm1hbGl6ZShwYXRoKTtcbiAgICBpZiAocGF0aFtwYXRoLmxlbmd0aCAtIDFdID09PSAnLycpIHtcbiAgICAgICAgcGF0aCA9IHBhdGguc2xpY2UoMCwgLTEpO1xuICAgIH1cbiAgICB2YXIgcGF0aDJ1dWlkID0gdGhpcy5fcGF0aFRvVXVpZDtcbiAgICB2YXIgdXVpZHMgPSBbXTtcbiAgICB2YXIgaXNDaGlsZENsYXNzT2YgPSBqcy5pc0NoaWxkQ2xhc3NPZjtcbiAgICB2YXIgX2ZvdW5kQXRsYXNVcmw7XG4gICAgZm9yICh2YXIgcCBpbiBwYXRoMnV1aWQpIHtcbiAgICAgICAgaWYgKChwLnN0YXJ0c1dpdGgocGF0aCkgJiYgaXNNYXRjaEJ5V29yZChwLCBwYXRoKSkgfHwgIXBhdGgpIHtcbiAgICAgICAgICAgIHZhciBpdGVtID0gcGF0aDJ1dWlkW3BdO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gaXRlbVtpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0eXBlIHx8IGlzQ2hpbGRDbGFzc09mKGVudHJ5LnR5cGUsIHR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1dWlkcy5wdXNoKGVudHJ5LnV1aWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG91dF91cmxzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0X3VybHMucHVzaChwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChDQ19ERUJVRyAmJiBlbnRyeS50eXBlID09PSBjYy5TcHJpdGVBdGxhcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgX2ZvdW5kQXRsYXNVcmwgPSBwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0eXBlIHx8IGlzQ2hpbGRDbGFzc09mKGl0ZW0udHlwZSwgdHlwZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdXVpZHMucHVzaChpdGVtLnV1aWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3V0X3VybHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dF91cmxzLnB1c2gocCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoQ0NfREVCVUcgJiYgaXRlbS50eXBlID09PSBjYy5TcHJpdGVBdGxhcykge1xuICAgICAgICAgICAgICAgICAgICBfZm91bmRBdGxhc1VybCA9IHA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChDQ19ERUJVRyAmJiB1dWlkcy5sZW5ndGggPT09IDAgJiYgX2ZvdW5kQXRsYXNVcmwgJiYganMuaXNDaGlsZENsYXNzT2YodHlwZSwgY2MuU3ByaXRlRnJhbWUpKSB7XG4gICAgICAgIC8vIG5vdCBzdXBwb3J0IHNwcml0ZSBmcmFtZSBpbiBhdGxhc1xuICAgICAgICBjYy5lcnJvcklEKDQ5MzIsIF9mb3VuZEF0bGFzVXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHV1aWRzO1xufTtcblxuLy8gLyoqXG4vLyAgKiAhI2VuIFJldHVybnMgYWxsIGFzc2V0IHBhdGhzIGluIHRoZSB0YWJsZS5cbi8vICAqICEjemgg6L+U5Zue6KGo5Lit55qE5omA5pyJ6LWE5rqQ6Lev5b6E44CCXG4vLyAgKiBAbWV0aG9kIGdldEFsbFBhdGhzXG4vLyAgKiBAcmV0dXJuIHtzdHJpbmdbXX1cbi8vICAqL1xuLy8gcHJvdG8uZ2V0QWxsUGF0aHMgPSBmdW5jdGlvbiAoKSB7XG4vLyAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX3BhdGhUb1V1aWQpO1xuLy8gfTtcblxuLyoqXG4gKiAhI2VuIFRPRE9cbiAqICEjemgg5Lul6Lev5b6E5Li6IGtlee+8jHV1aWQg5Li65YC85re75Yqg5Yiw6KGo5Lit44CCXG4gKiBAbWV0aG9kIGFkZFxuICogQHBhcmFtIHtTdHJpbmd9IHBhdGggLSB0aGUgcGF0aCB0byBsb2FkLCBzaG91bGQgTk9UIGluY2x1ZGUgZmlsZW5hbWUgZXh0ZW5zaW9ucy5cbiAqIEBwYXJhbSB7U3RyaW5nfSB1dWlkXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSB0eXBlXG4gKiBAcGFyYW0ge0Jvb2xlYW59IGlzTWFpbkFzc2V0XG4gKiBAcHJpdmF0ZVxuICovXG5wcm90by5hZGQgPSBmdW5jdGlvbiAocGF0aCwgdXVpZCwgdHlwZSwgaXNNYWluQXNzZXQpIHtcbiAgICAvLyByZW1vdmUgZXh0bmFtZVxuICAgIC8vIChjYW4gbm90IHVzZSBwYXRoLnNsaWNlIGJlY2F1c2UgbGVuZ3RoIG9mIGV4dG5hbWUgbWF5YmUgMClcbiAgICBwYXRoID0gcGF0aC5zdWJzdHJpbmcoMCwgcGF0aC5sZW5ndGggLSBjYy5wYXRoLmV4dG5hbWUocGF0aCkubGVuZ3RoKTtcbiAgICB2YXIgbmV3RW50cnkgPSBuZXcgRW50cnkodXVpZCwgdHlwZSk7XG4gICAgcHVzaFRvTWFwKHRoaXMuX3BhdGhUb1V1aWQsIHBhdGgsIG5ld0VudHJ5LCBpc01haW5Bc3NldCk7XG59O1xuXG5wcm90by5fZ2V0SW5mb19ERUJVRyA9IENDX0RFQlVHICYmIGZ1bmN0aW9uICh1dWlkLCBvdXRfaW5mbykge1xuICAgIHZhciBwYXRoMnV1aWQgPSB0aGlzLl9wYXRoVG9VdWlkO1xuICAgIHZhciBwYXRocyA9IE9iamVjdC5rZXlzKHBhdGgydXVpZCk7XG4gICAgZm9yICh2YXIgcCA9IDA7IHAgPCBwYXRocy5sZW5ndGg7ICsrcCkge1xuICAgICAgICB2YXIgcGF0aCA9IHBhdGhzW3BdO1xuICAgICAgICB2YXIgaXRlbSA9IHBhdGgydXVpZFtwYXRoXTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBlbnRyeSA9IGl0ZW1baV07XG4gICAgICAgICAgICAgICAgaWYgKGVudHJ5LnV1aWQgPT09IHV1aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0X2luZm8ucGF0aCA9IHBhdGg7XG4gICAgICAgICAgICAgICAgICAgIG91dF9pbmZvLnR5cGUgPSBlbnRyeS50eXBlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaXRlbS51dWlkID09PSB1dWlkKSB7XG4gICAgICAgICAgICBvdXRfaW5mby5wYXRoID0gcGF0aDtcbiAgICAgICAgICAgIG91dF9pbmZvLnR5cGUgPSBpdGVtLnR5cGU7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuXG5wcm90by5yZXNldCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9wYXRoVG9VdWlkID0ganMuY3JlYXRlTWFwKHRydWUpO1xufTtcblxuXG5tb2R1bGUuZXhwb3J0cyA9IEFzc2V0VGFibGU7XG4iXX0=