
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/3d/skeleton/CCSkinnedMeshRenderer.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

var _mat = _interopRequireDefault(require("../../value-types/mat4"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 http://www.cocos.com

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var Skeleton = require('./CCSkeleton');

var MeshRenderer = require('../../mesh/CCMeshRenderer');

var RenderFlow = require('../../renderer/render-flow');

var enums = require('../../../renderer/enums');

var _m4_tmp = cc.mat4();

var _m4_tmp2 = cc.mat4();
/**
 * !#en
 * Skinned Mesh Renderer
 * !#zh
 * 蒙皮渲染组件
 * @class SkinnedMeshRenderer
 */


var SkinnedMeshRenderer = cc.Class({
  name: 'cc.SkinnedMeshRenderer',
  "extends": MeshRenderer,
  editor: CC_EDITOR && {
    menu: 'i18n:MAIN_MENU.component.mesh/Skinned Mesh Renderer'
  },
  ctor: function ctor() {
    this._jointsData = this._jointsFloat32Data = null;
    this._jointsTexture = null;
    this._joints = [];
    this._dummyNode = new cc.Node();
    this._jointsTextureOptions = null;
    this._usingRGBA8Texture = false;
  },
  properties: {
    _skeleton: Skeleton,
    _rootBone: cc.Node,

    /**
     * !#en
     * Skeleton Asset
     * !#zh
     * 骨骼资源
     * @property {Skeleton} skeleton
     */
    skeleton: {
      get: function get() {
        return this._skeleton;
      },
      set: function set(val) {
        this._skeleton = val;

        this._init();
      },
      type: Skeleton
    },

    /**
     * !#en
     * Root Bone
     * !#zh
     * 骨骼根节点
     * @property {Node} rootBone
     */
    rootBone: {
      get: function get() {
        return this._rootBone;
      },
      set: function set(val) {
        this._rootBone = val;

        this._init();
      },
      type: cc.Node
    },
    // SkinnedMeshRenderer cannot batch
    enableAutoBatch: {
      get: function get() {
        return false;
      },
      visible: false,
      override: true
    }
  },
  __preload: function __preload() {
    this._super();

    this._init();
  },
  _init: function _init() {
    this._model = this._skeleton && this._skeleton.model;
    this._calFunc = null;

    this._initJoints();

    this._initJointsTexture();

    this._initCalcFunc();

    this._updateRenderNode();
  },
  _calcWorldMatrixToRoot: function _calcWorldMatrixToRoot(joint) {
    var worldMatrixToRoot = joint._worldMatrixToRoot;

    if (!worldMatrixToRoot) {
      joint._worldMatrixToRoot = worldMatrixToRoot = cc.mat4();
      joint.getLocalMatrix(worldMatrixToRoot);
    } else {
      return;
    }

    var parent = joint.parent;

    if (parent !== this.rootBone) {
      if (!parent._worldMatrixToRoot) {
        this._calcWorldMatrixToRoot(parent);
      }

      _mat["default"].mul(worldMatrixToRoot, parent._worldMatrixToRoot, worldMatrixToRoot);
    }
  },
  _validateRender: function _validateRender() {
    if (!this._jointsData) {
      this.disableRender();
      return;
    }

    this._super();
  },
  _initJoints: function _initJoints() {
    var joints = this._joints;
    joints.length = 0;
    if (!this.skeleton || !this.rootBone) return;

    var useJointMatrix = this._useJointMatrix();

    var jointPaths = this.skeleton.jointPaths;
    var rootBone = this.rootBone;

    for (var i = 0; i < jointPaths.length; i++) {
      var joint = cc.find(jointPaths[i], rootBone);

      if (!joint) {
        cc.warn('Can not find joint in root bone [%s] with path [%s]', rootBone.name, jointPaths[i]);
      }

      if (useJointMatrix) {
        joint._renderFlag &= ~RenderFlow.FLAG_CHILDREN;

        this._calcWorldMatrixToRoot(joint);
      }

      joints.push(joint);
    }

    if (useJointMatrix) {
      var uniqueBindPoses = this.skeleton.uniqueBindPoses;

      for (var _i = 0; _i < jointPaths.length; _i++) {
        var _joint = joints[_i];

        if (uniqueBindPoses[_i]) {
          _mat["default"].mul(_m4_tmp, _joint._worldMatrixToRoot, uniqueBindPoses[_i]);

          _joint._jointMatrix = _mat["default"].toArray([], _m4_tmp);
        } else {
          _joint._jointMatrix = _joint._worldMatrixToRoot;
        }
      }
    }
  },
  _initJointsTexture: function _initJointsTexture() {
    if (!this._skeleton) return;
    var jointCount = this._joints.length;
    var materials = this._materials;
    var inited = false;

    if (jointCount <= cc.sys.getMaxJointMatrixSize()) {
      inited = true;
      this._jointsData = this._jointsFloat32Data = new Float32Array(jointCount * 16);

      for (var i = 0; i < materials.length; i++) {
        materials[i].setProperty('jointMatrices', this._jointsFloat32Data, undefined, true);
        materials[i].define('CC_USE_JOINTS_TEXTRUE', false);
      }
    }

    if (!inited) {
      var SUPPORT_FLOAT_TEXTURE = !!cc.sys.glExtension('OES_texture_float');
      var size;

      if (jointCount > 256) {
        size = 64;
      } else if (jointCount > 64) {
        size = 32;
      } else if (jointCount > 16) {
        size = 16;
      } else {
        size = 8;
      }

      this._jointsData = this._jointsFloat32Data = new Float32Array(size * size * 4);
      var pixelFormat = cc.Texture2D.PixelFormat.RGBA32F,
          width = size,
          height = size;

      if (!SUPPORT_FLOAT_TEXTURE) {
        this._jointsData = new Uint8Array(this._jointsFloat32Data.buffer);
        pixelFormat = cc.Texture2D.PixelFormat.RGBA8888;
        width *= 4;
        this._usingRGBA8Texture = true;
        cc.warn("SkinnedMeshRenderer [" + this.node.name + "] has too many joints [" + jointCount + "] and device do not support float32 texture, fallback to use RGBA8888 texture, which is much slower.");
      }

      var texture = this._jointsTexture || new cc.Texture2D();
      var NEAREST = cc.Texture2D.Filter.NEAREST;
      texture.setFilters(NEAREST, NEAREST);
      texture.initWithData(this._jointsData, pixelFormat, width, height);
      this._jointsTexture = texture;
      this._jointsTextureOptions = {
        format: pixelFormat,
        width: texture.width,
        height: texture.height,
        images: []
      };

      for (var _i2 = 0; _i2 < materials.length; _i2++) {
        materials[_i2].setProperty('jointsTexture', texture);

        materials[_i2].setProperty('jointsTextureSize', new Float32Array([width, height]));

        materials[_i2].define('CC_JOINTS_TEXTURE_FLOAT32', SUPPORT_FLOAT_TEXTURE);

        materials[_i2].define('CC_USE_JOINTS_TEXTRUE', true);
      }
    }

    for (var _i3 = 0; _i3 < materials.length; _i3++) {
      materials[_i3].define('CC_USE_SKINNING', true);
    }
  },
  _setJointsDataWithArray: function _setJointsDataWithArray(iMatrix, matrixArray) {
    var data = this._jointsFloat32Data;
    data.set(matrixArray, iMatrix * 16);
  },
  _setJointsDataWithMatrix: function _setJointsDataWithMatrix(iMatrix, matrix) {
    this._jointsFloat32Data.set(matrix.m, 16 * iMatrix);
  },
  _commitJointsData: function _commitJointsData() {
    if (this._jointsTexture) {
      this._jointsTextureOptions.images[0] = this._jointsData;

      this._jointsTexture.update(this._jointsTextureOptions);
    }
  },
  _useJointMatrix: function _useJointMatrix() {
    return this._model && this._model.precomputeJointMatrix;
  },
  _updateRenderNode: function _updateRenderNode() {
    if (this._useJointMatrix() || this._usingRGBA8Texture) {
      this._assembler.setRenderNode(this.rootBone);
    } else {
      this._assembler.setRenderNode(this._dummyNode);
    }
  },
  _initCalcFunc: function _initCalcFunc() {
    if (this._useJointMatrix()) {
      this._calFunc = this._calJointMatrix;
    } else if (this._usingRGBA8Texture) {
      this._calFunc = this._calRGBA8WorldMatrix;
    } else {
      this._calFunc = this._calWorldMatrix;
    }
  },
  _calJointMatrix: function _calJointMatrix() {
    var joints = this._joints;
    var bindposes = this.skeleton.bindposes;
    var uniqueBindPoses = this.skeleton.uniqueBindPoses;

    for (var i = 0; i < joints.length; ++i) {
      var joint = joints[i];
      var jointMatrix = joint._jointMatrix;

      if (uniqueBindPoses[i]) {
        this._setJointsDataWithArray(i, jointMatrix);
      } else {
        _mat["default"].multiply(_m4_tmp, jointMatrix, bindposes[i]);

        this._setJointsDataWithMatrix(i, _m4_tmp);
      }
    }
  },
  // Some device rgba8 texture precision is low, when encode a big number it may loss precision.
  // Invert root bone matrix can effectively avoid big position encode into rgba8 texture.
  _calRGBA8WorldMatrix: function _calRGBA8WorldMatrix() {
    var joints = this._joints;
    var bindposes = this.skeleton.bindposes;

    this.rootBone._updateWorldMatrix();

    var rootMatrix = this.rootBone._worldMatrix;

    var invRootMat = _mat["default"].invert(_m4_tmp2, rootMatrix);

    for (var i = 0; i < joints.length; ++i) {
      var joint = joints[i];

      joint._updateWorldMatrix();

      _mat["default"].multiply(_m4_tmp, invRootMat, joint._worldMatrix);

      _mat["default"].multiply(_m4_tmp, _m4_tmp, bindposes[i]);

      this._setJointsDataWithMatrix(i, _m4_tmp);
    }
  },
  _calWorldMatrix: function _calWorldMatrix() {
    var joints = this._joints;
    var bindposes = this.skeleton.bindposes;

    for (var i = 0; i < joints.length; ++i) {
      var joint = joints[i];

      joint._updateWorldMatrix();

      _mat["default"].multiply(_m4_tmp, joint._worldMatrix, bindposes[i]);

      this._setJointsDataWithMatrix(i, _m4_tmp);
    }
  },
  calcJointMatrix: function calcJointMatrix() {
    if (!this.skeleton || !this.rootBone) return;

    this._calFunc.call(this);

    this._commitJointsData();
  }
});
cc.SkinnedMeshRenderer = module.exports = SkinnedMeshRenderer;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNDU2tpbm5lZE1lc2hSZW5kZXJlci5qcyJdLCJuYW1lcyI6WyJTa2VsZXRvbiIsInJlcXVpcmUiLCJNZXNoUmVuZGVyZXIiLCJSZW5kZXJGbG93IiwiZW51bXMiLCJfbTRfdG1wIiwiY2MiLCJtYXQ0IiwiX200X3RtcDIiLCJTa2lubmVkTWVzaFJlbmRlcmVyIiwiQ2xhc3MiLCJuYW1lIiwiZWRpdG9yIiwiQ0NfRURJVE9SIiwibWVudSIsImN0b3IiLCJfam9pbnRzRGF0YSIsIl9qb2ludHNGbG9hdDMyRGF0YSIsIl9qb2ludHNUZXh0dXJlIiwiX2pvaW50cyIsIl9kdW1teU5vZGUiLCJOb2RlIiwiX2pvaW50c1RleHR1cmVPcHRpb25zIiwiX3VzaW5nUkdCQThUZXh0dXJlIiwicHJvcGVydGllcyIsIl9za2VsZXRvbiIsIl9yb290Qm9uZSIsInNrZWxldG9uIiwiZ2V0Iiwic2V0IiwidmFsIiwiX2luaXQiLCJ0eXBlIiwicm9vdEJvbmUiLCJlbmFibGVBdXRvQmF0Y2giLCJ2aXNpYmxlIiwib3ZlcnJpZGUiLCJfX3ByZWxvYWQiLCJfc3VwZXIiLCJfbW9kZWwiLCJtb2RlbCIsIl9jYWxGdW5jIiwiX2luaXRKb2ludHMiLCJfaW5pdEpvaW50c1RleHR1cmUiLCJfaW5pdENhbGNGdW5jIiwiX3VwZGF0ZVJlbmRlck5vZGUiLCJfY2FsY1dvcmxkTWF0cml4VG9Sb290Iiwiam9pbnQiLCJ3b3JsZE1hdHJpeFRvUm9vdCIsIl93b3JsZE1hdHJpeFRvUm9vdCIsImdldExvY2FsTWF0cml4IiwicGFyZW50IiwiTWF0NCIsIm11bCIsIl92YWxpZGF0ZVJlbmRlciIsImRpc2FibGVSZW5kZXIiLCJqb2ludHMiLCJsZW5ndGgiLCJ1c2VKb2ludE1hdHJpeCIsIl91c2VKb2ludE1hdHJpeCIsImpvaW50UGF0aHMiLCJpIiwiZmluZCIsIndhcm4iLCJfcmVuZGVyRmxhZyIsIkZMQUdfQ0hJTERSRU4iLCJwdXNoIiwidW5pcXVlQmluZFBvc2VzIiwiX2pvaW50TWF0cml4IiwidG9BcnJheSIsImpvaW50Q291bnQiLCJtYXRlcmlhbHMiLCJfbWF0ZXJpYWxzIiwiaW5pdGVkIiwic3lzIiwiZ2V0TWF4Sm9pbnRNYXRyaXhTaXplIiwiRmxvYXQzMkFycmF5Iiwic2V0UHJvcGVydHkiLCJ1bmRlZmluZWQiLCJkZWZpbmUiLCJTVVBQT1JUX0ZMT0FUX1RFWFRVUkUiLCJnbEV4dGVuc2lvbiIsInNpemUiLCJwaXhlbEZvcm1hdCIsIlRleHR1cmUyRCIsIlBpeGVsRm9ybWF0IiwiUkdCQTMyRiIsIndpZHRoIiwiaGVpZ2h0IiwiVWludDhBcnJheSIsImJ1ZmZlciIsIlJHQkE4ODg4Iiwibm9kZSIsInRleHR1cmUiLCJORUFSRVNUIiwiRmlsdGVyIiwic2V0RmlsdGVycyIsImluaXRXaXRoRGF0YSIsImZvcm1hdCIsImltYWdlcyIsIl9zZXRKb2ludHNEYXRhV2l0aEFycmF5IiwiaU1hdHJpeCIsIm1hdHJpeEFycmF5IiwiZGF0YSIsIl9zZXRKb2ludHNEYXRhV2l0aE1hdHJpeCIsIm1hdHJpeCIsIm0iLCJfY29tbWl0Sm9pbnRzRGF0YSIsInVwZGF0ZSIsInByZWNvbXB1dGVKb2ludE1hdHJpeCIsIl9hc3NlbWJsZXIiLCJzZXRSZW5kZXJOb2RlIiwiX2NhbEpvaW50TWF0cml4IiwiX2NhbFJHQkE4V29ybGRNYXRyaXgiLCJfY2FsV29ybGRNYXRyaXgiLCJiaW5kcG9zZXMiLCJqb2ludE1hdHJpeCIsIm11bHRpcGx5IiwiX3VwZGF0ZVdvcmxkTWF0cml4Iiwicm9vdE1hdHJpeCIsIl93b3JsZE1hdHJpeCIsImludlJvb3RNYXQiLCJpbnZlcnQiLCJjYWxjSm9pbnRNYXRyaXgiLCJjYWxsIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQXlCQTs7OztBQXpCQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBMEJBLElBQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBeEI7O0FBQ0EsSUFBTUMsWUFBWSxHQUFHRCxPQUFPLENBQUMsMkJB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ZXNDb250ZW50IjpbIi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gQ29weXJpZ2h0IChjKSAyMDE3LTIwMTggWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXG5cbiBodHRwOi8vd3d3LmNvY29zLmNvbVxuXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZW5naW5lIHNvdXJjZSBjb2RlICh0aGUgXCJTb2Z0d2FyZVwiKSwgYSBsaW1pdGVkLFxuICB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcbiAgbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xuICB1c2VkIGZvciBkZXZlbG9waW5nIGdhbWVzLiBZb3UgYXJlIG5vdCBncmFudGVkIHRvIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxuXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbiBUSEUgU09GVFdBUkUuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IE1hdDQgZnJvbSAnLi4vLi4vdmFsdWUtdHlwZXMvbWF0NCc7XG5jb25zdCBTa2VsZXRvbiA9IHJlcXVpcmUoJy4vQ0NTa2VsZXRvbicpO1xuY29uc3QgTWVzaFJlbmRlcmVyID0gcmVxdWlyZSgnLi4vLi4vbWVzaC9DQ01lc2hSZW5kZXJlcicpO1xuY29uc3QgUmVuZGVyRmxvdyA9IHJlcXVpcmUoJy4uLy4uL3JlbmRlcmVyL3JlbmRlci1mbG93Jyk7XG5jb25zdCBlbnVtcyA9IHJlcXVpcmUoJy4uLy4uLy4uL3JlbmRlcmVyL2VudW1zJyk7XG5cbmxldCBfbTRfdG1wID0gY2MubWF0NCgpO1xubGV0IF9tNF90bXAyID0gY2MubWF0NCgpO1xuXG4vKipcbiAqICEjZW5cbiAqIFNraW5uZWQgTWVzaCBSZW5kZXJlclxuICogISN6aFxuICog6JKZ55qu5riy5p+T57uE5Lu2XG4gKiBAY2xhc3MgU2tpbm5lZE1lc2hSZW5kZXJlclxuICovXG5sZXQgU2tpbm5lZE1lc2hSZW5kZXJlciA9IGNjLkNsYXNzKHtcbiAgICBuYW1lOiAnY2MuU2tpbm5lZE1lc2hSZW5kZXJlcicsXG4gICAgZXh0ZW5kczogTWVzaFJlbmRlcmVyLFxuXG4gICAgZWRpdG9yOiBDQ19FRElUT1IgJiYge1xuICAgICAgICBtZW51OiAnaTE4bjpNQUlOX01FTlUuY29tcG9uZW50Lm1lc2gvU2tpbm5lZCBNZXNoIFJlbmRlcmVyJyxcbiAgICB9LFxuXG4gICAgY3RvciAoKSB7XG4gICAgICAgIHRoaXMuX2pvaW50c0RhdGEgPSB0aGlzLl9qb2ludHNGbG9hdDMyRGF0YSA9IG51bGw7XG4gICAgICAgIHRoaXMuX2pvaW50c1RleHR1cmUgPSBudWxsO1xuICAgICAgICB0aGlzLl9qb2ludHMgPSBbXTtcbiAgICAgICAgdGhpcy5fZHVtbXlOb2RlID0gbmV3IGNjLk5vZGUoKTtcbiAgICAgICAgdGhpcy5fam9pbnRzVGV4dHVyZU9wdGlvbnMgPSBudWxsO1xuICAgICAgICB0aGlzLl91c2luZ1JHQkE4VGV4dHVyZSA9IGZhbHNlO1xuICAgIH0sXG5cbiAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIF9za2VsZXRvbjogU2tlbGV0b24sXG4gICAgICAgIF9yb290Qm9uZTogY2MuTm9kZSxcblxuICAgICAgICAvKipcbiAgICAgICAgICogISNlblxuICAgICAgICAgKiBTa2VsZXRvbiBBc3NldFxuICAgICAgICAgKiAhI3poXG4gICAgICAgICAqIOmqqOmqvOi1hOa6kFxuICAgICAgICAgKiBAcHJvcGVydHkge1NrZWxldG9ufSBza2VsZXRvblxuICAgICAgICAgKi9cbiAgICAgICAgc2tlbGV0b246IHtcbiAgICAgICAgICAgIGdldCAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NrZWxldG9uO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldCAodmFsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2tlbGV0b24gPSB2YWw7XG4gICAgICAgICAgICAgICAgdGhpcy5faW5pdCgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHR5cGU6IFNrZWxldG9uXG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqICEjZW5cbiAgICAgICAgICogUm9vdCBCb25lXG4gICAgICAgICAqICEjemhcbiAgICAgICAgICog6aqo6aq85qC56IqC54K5XG4gICAgICAgICAqIEBwcm9wZXJ0eSB7Tm9kZX0gcm9vdEJvbmVcbiAgICAgICAgICovXG4gICAgICAgIHJvb3RCb25lOiB7XG4gICAgICAgICAgICBnZXQgKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb290Qm9uZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXQgKHZhbCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3Jvb3RCb25lID0gdmFsO1xuICAgICAgICAgICAgICAgIHRoaXMuX2luaXQoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0eXBlOiBjYy5Ob2RlXG4gICAgICAgIH0sXG5cbiAgICAgICAgLy8gU2tpbm5lZE1lc2hSZW5kZXJlciBjYW5ub3QgYmF0Y2hcbiAgICAgICAgZW5hYmxlQXV0b0JhdGNoOiB7XG4gICAgICAgICAgICBnZXQgKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB2aXNpYmxlOiBmYWxzZSxcbiAgICAgICAgICAgIG92ZXJyaWRlOiB0cnVlXG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgX19wcmVsb2FkICgpIHtcbiAgICAgICAgdGhpcy5fc3VwZXIoKTtcbiAgICAgICAgdGhpcy5faW5pdCgpO1xuICAgIH0sXG5cbiAgICBfaW5pdCAoKSB7XG4gICAgICAgIHRoaXMuX21vZGVsID0gdGhpcy5fc2tlbGV0b24gJiYgdGhpcy5fc2tlbGV0b24ubW9kZWw7XG4gICAgICAgIHRoaXMuX2NhbEZ1bmMgPSBudWxsO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5faW5pdEpvaW50cygpO1xuICAgICAgICB0aGlzLl9pbml0Sm9pbnRzVGV4dHVyZSgpO1xuICAgICAgICB0aGlzLl9pbml0Q2FsY0Z1bmMoKTtcbiAgICAgICAgdGhpcy5fdXBkYXRlUmVuZGVyTm9kZSgpO1xuICAgIH0sXG5cbiAgICBfY2FsY1dvcmxkTWF0cml4VG9Sb290IChqb2ludCkge1xuICAgICAgICBsZXQgd29ybGRNYXRyaXhUb1Jvb3QgPSBqb2ludC5fd29ybGRNYXRyaXhUb1Jvb3Q7XG4gICAgICAgIGlmICghd29ybGRNYXRyaXhUb1Jvb3QpIHtcbiAgICAgICAgICAgIGpvaW50Ll93b3JsZE1hdHJpeFRvUm9vdCA9IHdvcmxkTWF0cml4VG9Sb290ID0gY2MubWF0NCgpO1xuICAgICAgICAgICAgam9pbnQuZ2V0TG9jYWxNYXRyaXgod29ybGRNYXRyaXhUb1Jvb3QpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHBhcmVudCA9IGpvaW50LnBhcmVudDtcbiAgICAgICAgaWYgKHBhcmVudCAhPT0gdGhpcy5yb290Qm9uZSkge1xuICAgICAgICAgICAgaWYgKCFwYXJlbnQuX3dvcmxkTWF0cml4VG9Sb290KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY2FsY1dvcmxkTWF0cml4VG9Sb290KHBhcmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBNYXQ0Lm11bCh3b3JsZE1hdHJpeFRvUm9vdCwgcGFyZW50Ll93b3JsZE1hdHJpeFRvUm9vdCwgd29ybGRNYXRyaXhUb1Jvb3QpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF92YWxpZGF0ZVJlbmRlciAoKSB7XG4gICAgICAgIGlmICghdGhpcy5fam9pbnRzRGF0YSkge1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUmVuZGVyKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fc3VwZXIoKTtcbiAgICB9LFxuXG4gICAgX2luaXRKb2ludHMgKCkge1xuICAgICAgICBsZXQgam9pbnRzID0gdGhpcy5fam9pbnRzO1xuICAgICAgICBqb2ludHMubGVuZ3RoID0gMDtcblxuICAgICAgICBpZiAoIXRoaXMuc2tlbGV0b24gfHwgIXRoaXMucm9vdEJvbmUpIHJldHVybjtcblxuICAgICAgICBsZXQgdXNlSm9pbnRNYXRyaXggPSB0aGlzLl91c2VKb2ludE1hdHJpeCgpO1xuXG4gICAgICAgIGxldCBqb2ludFBhdGhzID0gdGhpcy5za2VsZXRvbi5qb2ludFBhdGhzO1xuICAgICAgICBsZXQgcm9vdEJvbmUgPSB0aGlzLnJvb3RCb25lO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGpvaW50UGF0aHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGxldCBqb2ludCA9IGNjLmZpbmQoam9pbnRQYXRoc1tpXSwgcm9vdEJvbmUpO1xuICAgICAgICAgICAgaWYgKCFqb2ludCkge1xuICAgICAgICAgICAgICAgIGNjLndhcm4oJ0NhbiBub3QgZmluZCBqb2ludCBpbiByb290IGJvbmUgWyVzXSB3aXRoIHBhdGggWyVzXScsIHJvb3RCb25lLm5hbWUsIGpvaW50UGF0aHNbaV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodXNlSm9pbnRNYXRyaXgpIHtcbiAgICAgICAgICAgICAgICBqb2ludC5fcmVuZGVyRmxhZyAmPSB+UmVuZGVyRmxvdy5GTEFHX0NISUxEUkVOO1xuICAgICAgICAgICAgICAgIHRoaXMuX2NhbGNXb3JsZE1hdHJpeFRvUm9vdChqb2ludCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGpvaW50cy5wdXNoKGpvaW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh1c2VKb2ludE1hdHJpeCkge1xuICAgICAgICAgICAgY29uc3QgdW5pcXVlQmluZFBvc2VzID0gdGhpcy5za2VsZXRvbi51bmlxdWVCaW5kUG9zZXM7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGpvaW50UGF0aHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgam9pbnQgPSBqb2ludHNbaV07XG4gICAgICAgICAgICAgICAgaWYgKHVuaXF1ZUJpbmRQb3Nlc1tpXSkge1xuICAgICAgICAgICAgICAgICAgICBNYXQ0Lm11bChfbTRfdG1wLCBqb2ludC5fd29ybGRNYXRyaXhUb1Jvb3QsIHVuaXF1ZUJpbmRQb3Nlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIGpvaW50Ll9qb2ludE1hdHJpeCA9IE1hdDQudG9BcnJheShbXSwgX200X3RtcCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBqb2ludC5fam9pbnRNYXRyaXggPSBqb2ludC5fd29ybGRNYXRyaXhUb1Jvb3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9pbml0Sm9pbnRzVGV4dHVyZSAoKSB7XG4gICAgICAgIGlmICghdGhpcy5fc2tlbGV0b24pIHJldHVybjtcblxuICAgICAgICBsZXQgam9pbnRDb3VudCA9IHRoaXMuX2pvaW50cy5sZW5ndGg7XG4gICAgICAgIGxldCBtYXRlcmlhbHMgPSB0aGlzLl9tYXRlcmlhbHM7XG5cbiAgICAgICAgbGV0IGluaXRlZCA9IGZhbHNlO1xuICAgICAgICBpZiAoam9pbnRDb3VudCA8PSBjYy5zeXMuZ2V0TWF4Sm9pbnRNYXRyaXhTaXplKCkpIHtcbiAgICAgICAgICAgIGluaXRlZCA9IHRydWU7XG5cbiAgICAgICAgICAgIHRoaXMuX2pvaW50c0RhdGEgPSB0aGlzLl9qb2ludHNGbG9hdDMyRGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoam9pbnRDb3VudCAqIDE2KTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF0ZXJpYWxzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxzW2ldLnNldFByb3BlcnR5KCdqb2ludE1hdHJpY2VzJywgdGhpcy5fam9pbnRzRmxvYXQzMkRhdGEsIHVuZGVmaW5lZCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxzW2ldLmRlZmluZSgnQ0NfVVNFX0pPSU5UU19URVhUUlVFJywgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFpbml0ZWQpIHtcbiAgICAgICAgICAgIGxldCBTVVBQT1JUX0ZMT0FUX1RFWFRVUkUgPSAhIWNjLnN5cy5nbEV4dGVuc2lvbignT0VTX3RleHR1cmVfZmxvYXQnKTtcbiAgICAgICAgICAgIGxldCBzaXplO1xuICAgICAgICAgICAgaWYgKGpvaW50Q291bnQgPiAyNTYpIHtcbiAgICAgICAgICAgICAgICBzaXplID0gNjQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvaW50Q291bnQgPiA2NCkge1xuICAgICAgICAgICAgICAgIHNpemUgPSAzMjtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoam9pbnRDb3VudCA+IDE2KSB7XG4gICAgICAgICAgICAgICAgc2l6ZSA9IDE2O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzaXplID0gODtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5fam9pbnRzRGF0YSA9IHRoaXMuX2pvaW50c0Zsb2F0MzJEYXRhID0gbmV3IEZsb2F0MzJBcnJheShzaXplICogc2l6ZSAqIDQpO1xuXG4gICAgICAgICAgICBsZXQgcGl4ZWxGb3JtYXQgPSBjYy5UZXh0dXJlMkQuUGl4ZWxGb3JtYXQuUkdCQTMyRiwgXG4gICAgICAgICAgICAgICAgd2lkdGggPSBzaXplLCBcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBzaXplO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoIVNVUFBPUlRfRkxPQVRfVEVYVFVSRSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2pvaW50c0RhdGEgPSBuZXcgVWludDhBcnJheSh0aGlzLl9qb2ludHNGbG9hdDMyRGF0YS5idWZmZXIpO1xuICAgICAgICAgICAgICAgIHBpeGVsRm9ybWF0ID0gY2MuVGV4dHVyZTJELlBpeGVsRm9ybWF0LlJHQkE4ODg4O1xuICAgICAgICAgICAgICAgIHdpZHRoICo9IDQ7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl91c2luZ1JHQkE4VGV4dHVyZSA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICBjYy53YXJuKGBTa2lubmVkTWVzaFJlbmRlcmVyIFske3RoaXMubm9kZS5uYW1lfV0gaGFzIHRvbyBtYW55IGpvaW50cyBbJHtqb2ludENvdW50fV0gYW5kIGRldmljZSBkbyBub3Qgc3VwcG9ydCBmbG9hdDMyIHRleHR1cmUsIGZhbGxiYWNrIHRvIHVzZSBSR0JBODg4OCB0ZXh0dXJlLCB3aGljaCBpcyBtdWNoIHNsb3dlci5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHRleHR1cmUgPSB0aGlzLl9qb2ludHNUZXh0dXJlIHx8IG5ldyBjYy5UZXh0dXJlMkQoKTtcbiAgICAgICAgICAgIGxldCBORUFSRVNUID0gY2MuVGV4dHVyZTJELkZpbHRlci5ORUFSRVNUO1xuICAgICAgICAgICAgdGV4dHVyZS5zZXRGaWx0ZXJzKE5FQVJFU1QsIE5FQVJFU1QpO1xuICAgICAgICAgICAgdGV4dHVyZS5pbml0V2l0aERhdGEodGhpcy5fam9pbnRzRGF0YSwgcGl4ZWxGb3JtYXQsIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgICAgICAgdGhpcy5fam9pbnRzVGV4dHVyZSA9IHRleHR1cmU7XG4gICAgICAgICAgICB0aGlzLl9qb2ludHNUZXh0dXJlT3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBmb3JtYXQ6IHBpeGVsRm9ybWF0LCBcbiAgICAgICAgICAgICAgICB3aWR0aDogdGV4dHVyZS53aWR0aCwgXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiB0ZXh0dXJlLmhlaWdodCwgXG4gICAgICAgICAgICAgICAgaW1hZ2VzOltdXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1hdGVyaWFscy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIG1hdGVyaWFsc1tpXS5zZXRQcm9wZXJ0eSgnam9pbnRzVGV4dHVyZScsIHRleHR1cmUpO1xuICAgICAgICAgICAgICAgIG1hdGVyaWFsc1tpXS5zZXRQcm9wZXJ0eSgnam9pbnRzVGV4dHVyZVNpemUnLCBuZXcgRmxvYXQzMkFycmF5KFt3aWR0aCwgaGVpZ2h0XSkpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIG1hdGVyaWFsc1tpXS5kZWZpbmUoJ0NDX0pPSU5UU19URVhUVVJFX0ZMT0FUMzInLCBTVVBQT1JUX0ZMT0FUX1RFWFRVUkUpO1xuICAgICAgICAgICAgICAgIG1hdGVyaWFsc1tpXS5kZWZpbmUoJ0NDX1VTRV9KT0lOVFNfVEVYVFJVRScsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXRlcmlhbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIG1hdGVyaWFsc1tpXS5kZWZpbmUoJ0NDX1VTRV9TS0lOTklORycsIHRydWUpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9zZXRKb2ludHNEYXRhV2l0aEFycmF5IChpTWF0cml4LCBtYXRyaXhBcnJheSkge1xuICAgICAgICBsZXQgZGF0YSA9IHRoaXMuX2pvaW50c0Zsb2F0MzJEYXRhO1xuICAgICAgICBkYXRhLnNldChtYXRyaXhBcnJheSwgaU1hdHJpeCAqIDE2KTtcbiAgICB9LFxuXG4gICAgX3NldEpvaW50c0RhdGFXaXRoTWF0cml4IChpTWF0cml4LCBtYXRyaXgpIHtcbiAgICAgICAgdGhpcy5fam9pbnRzRmxvYXQzMkRhdGEuc2V0KG1hdHJpeC5tLCAxNiAqIGlNYXRyaXgpO1xuICAgIH0sXG5cbiAgICBfY29tbWl0Sm9pbnRzRGF0YSAoKSB7XG4gICAgICAgIGlmICh0aGlzLl9qb2ludHNUZXh0dXJlKSB7XG4gICAgICAgICAgICB0aGlzLl9qb2ludHNUZXh0dXJlT3B0aW9ucy5pbWFnZXNbMF0gPSB0aGlzLl9qb2ludHNEYXRhO1xuICAgICAgICAgICAgdGhpcy5fam9pbnRzVGV4dHVyZS51cGRhdGUodGhpcy5fam9pbnRzVGV4dHVyZU9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF91c2VKb2ludE1hdHJpeCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tb2RlbCAmJiB0aGlzLl9tb2RlbC5wcmVjb21wdXRlSm9pbnRNYXRyaXg7XG4gICAgfSxcblxuICAgIF91cGRhdGVSZW5kZXJOb2RlICgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3VzZUpvaW50TWF0cml4KCkgfHwgdGhpcy5fdXNpbmdSR0JBOFRleHR1cmUpIHtcbiAgICAgICAgICAgIHRoaXMuX2Fzc2VtYmxlci5zZXRSZW5kZXJOb2RlKHRoaXMucm9vdEJvbmUpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9hc3NlbWJsZXIuc2V0UmVuZGVyTm9kZSh0aGlzLl9kdW1teU5vZGUpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9pbml0Q2FsY0Z1bmMgKCkge1xuICAgICAgICBpZiAodGhpcy5fdXNlSm9pbnRNYXRyaXgoKSkge1xuICAgICAgICAgICAgdGhpcy5fY2FsRnVuYyA9IHRoaXMuX2NhbEpvaW50TWF0cml4O1xuICAgICAgICB9IFxuICAgICAgICBlbHNlIGlmICh0aGlzLl91c2luZ1JHQkE4VGV4dHVyZSkge1xuICAgICAgICAgICAgdGhpcy5fY2FsRnVuYyA9IHRoaXMuX2NhbFJHQkE4V29ybGRNYXRyaXg7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9jYWxGdW5jID0gdGhpcy5fY2FsV29ybGRNYXRyaXg7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgX2NhbEpvaW50TWF0cml4ICgpIHtcbiAgICAgICAgY29uc3Qgam9pbnRzID0gdGhpcy5fam9pbnRzO1xuICAgICAgICBjb25zdCBiaW5kcG9zZXMgPSB0aGlzLnNrZWxldG9uLmJpbmRwb3NlcztcbiAgICAgICAgY29uc3QgdW5pcXVlQmluZFBvc2VzID0gdGhpcy5za2VsZXRvbi51bmlxdWVCaW5kUG9zZXM7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgam9pbnRzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICBsZXQgam9pbnQgPSBqb2ludHNbaV07XG4gICAgICAgICAgICBsZXQgam9pbnRNYXRyaXggPSBqb2ludC5fam9pbnRNYXRyaXg7XG5cbiAgICAgICAgICAgIGlmICh1bmlxdWVCaW5kUG9zZXNbaV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zZXRKb2ludHNEYXRhV2l0aEFycmF5KGksIGpvaW50TWF0cml4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIE1hdDQubXVsdGlwbHkoX200X3RtcCwgam9pbnRNYXRyaXgsIGJpbmRwb3Nlc1tpXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2V0Sm9pbnRzRGF0YVdpdGhNYXRyaXgoaSwgX200X3RtcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLy8gU29tZSBkZXZpY2UgcmdiYTggdGV4dHVyZSBwcmVjaXNpb24gaXMgbG93LCB3aGVuIGVuY29kZSBhIGJpZyBudW1iZXIgaXQgbWF5IGxvc3MgcHJlY2lzaW9uLlxuICAgIC8vIEludmVydCByb290IGJvbmUgbWF0cml4IGNhbiBlZmZlY3RpdmVseSBhdm9pZCBiaWcgcG9zaXRpb24gZW5jb2RlIGludG8gcmdiYTggdGV4dHVyZS5cbiAgICBfY2FsUkdCQThXb3JsZE1hdHJpeCAoKSB7XG4gICAgICAgIGNvbnN0IGpvaW50cyA9IHRoaXMuX2pvaW50cztcbiAgICAgICAgY29uc3QgYmluZHBvc2VzID0gdGhpcy5za2VsZXRvbi5iaW5kcG9zZXM7XG5cbiAgICAgICAgdGhpcy5yb290Qm9uZS5fdXBkYXRlV29ybGRNYXRyaXgoKTtcbiAgICAgICAgbGV0IHJvb3RNYXRyaXggPSB0aGlzLnJvb3RCb25lLl93b3JsZE1hdHJpeDtcbiAgICAgICAgbGV0IGludlJvb3RNYXQgPSBNYXQ0LmludmVydChfbTRfdG1wMiwgcm9vdE1hdHJpeCk7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBqb2ludHMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIGxldCBqb2ludCA9IGpvaW50c1tpXTtcbiAgICAgICAgICAgIGpvaW50Ll91cGRhdGVXb3JsZE1hdHJpeCgpO1xuXG4gICAgICAgICAgICBNYXQ0Lm11bHRpcGx5KF9tNF90bXAsIGludlJvb3RNYXQsIGpvaW50Ll93b3JsZE1hdHJpeCk7XG4gICAgICAgICAgICBNYXQ0Lm11bHRpcGx5KF9tNF90bXAsIF9tNF90bXAsIGJpbmRwb3Nlc1tpXSk7XG4gICAgICAgICAgICB0aGlzLl9zZXRKb2ludHNEYXRhV2l0aE1hdHJpeChpLCBfbTRfdG1wKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBfY2FsV29ybGRNYXRyaXggKCkge1xuICAgICAgICBjb25zdCBqb2ludHMgPSB0aGlzLl9qb2ludHM7XG4gICAgICAgIGNvbnN0IGJpbmRwb3NlcyA9IHRoaXMuc2tlbGV0b24uYmluZHBvc2VzO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGpvaW50cy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgbGV0IGpvaW50ID0gam9pbnRzW2ldO1xuXG4gICAgICAgICAgICBqb2ludC5fdXBkYXRlV29ybGRNYXRyaXgoKTtcbiAgICAgICAgICAgIE1hdDQubXVsdGlwbHkoX200X3RtcCwgam9pbnQuX3dvcmxkTWF0cml4LCBiaW5kcG9zZXNbaV0pO1xuICAgICAgICAgICAgdGhpcy5fc2V0Sm9pbnRzRGF0YVdpdGhNYXRyaXgoaSwgX200X3RtcCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgY2FsY0pvaW50TWF0cml4ICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnNrZWxldG9uIHx8ICF0aGlzLnJvb3RCb25lKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5fY2FsRnVuYy5jYWxsKHRoaXMpO1xuICAgICAgICB0aGlzLl9jb21taXRKb2ludHNEYXRhKCk7XG4gICAgfVxufSk7XG5cbmNjLlNraW5uZWRNZXNoUmVuZGVyZXIgPSBtb2R1bGUuZXhwb3J0cyA9IFNraW5uZWRNZXNoUmVuZGVyZXI7XG4iXX0=