
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/animation/animation-animator.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
 worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
 not use Cocos Creator software for developing other software or tools that's
 used for developing games. You are not granted to publish, distribute,
 sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var js = cc.js;

var Playable = require('./playable');

var _require = require('./animation-curves'),
    EventAnimCurve = _require.EventAnimCurve,
    EventInfo = _require.EventInfo;

var WrapModeMask = require('./types').WrapModeMask;

var binarySearch = require('../core/utils/binary-search').binarySearchEpsilon; // The actual animator for Animation Component


function AnimationAnimator(target, animation) {
  Playable.call(this);
  this.target = target;
  this.animation = animation;
  this._anims = new js.array.MutableForwardIterator([]);
}

js.extend(AnimationAnimator, Playable);
var p = AnimationAnimator.prototype;

p.playState = function (state, startTime) {
  if (!state.clip) {
    return;
  }

  if (!state.curveLoaded) {
    initClipData(this.target, state);
  }

  state.animator = this;
  state.play();

  if (typeof startTime === 'number') {
    state.setTime(startTime);
  }

  this.play();
};

p.stopStatesExcept = function (state) {
  var iterator = this._anims;
  var array = iterator.array;

  for (iterator.i = 0; iterator.i < array.length; ++iterator.i) {
    var anim = array[iterator.i];

    if (anim === state) {
      continue;
    }

    this.stopState(anim);
  }
};

p.addAnimation = function (anim) {
  var index = this._anims.array.indexOf(anim);

  if (index === -1) {
    this._anims.push(anim);
  }

  anim._setEventTarget(this.animation);
};

p.removeAnimation = function (anim) {
  var index = this._anims.array.indexOf(anim);

  if (index >= 0) {
    this._anims.fastRemoveAt(index);

    if (this._anims.array.length === 0) {
      this.stop();
    }
  } else {
    cc.errorID(3908);
  }

  anim.animator = null;
};

p.sample = function () {
  var iterator = this._anims;
  var array = iterator.array;

  for (iterator.i = 0; iterator.i < array.length; ++iterator.i) {
    var anim = array[iterator.i];
    anim.sample();
  }
};

p.stopState = function (state) {
  if (state) {
    state.stop();
  }
};

p.pauseState = function (state) {
  if (state) {
    state.pause();
  }
};

p.resumeState = function (state) {
  if (state) {
    state.resume();
  }

  if (this.isPaused) {
    this.resume();
  }
};

p.setStateTime = function (state, time) {
  if (time !== undefined) {
    if (state) {
      state.setTime(time);
      state.sample();
    }
  } else {
    time = state;
    var array = this._anims.array;

    for (var i = 0; i < array.length; ++i) {
      var anim = array[i];
      anim.setTime(time);
      anim.sample();
    }
  }
};

p.onStop = function () {
  var iterator = this._anims;
  var array = iterator.array;

  for (iterator.i = 0; iterator.i < array.length; ++iterator.i) {
    var anim = array[iterator.i];
    anim.stop();
  }
};

p.onPause = function () {
  var array = this._anims.array;

  for (var i = 0; i < array.length; ++i) {
    var anim = array[i];
    anim.pause(); // need to unbind animator to anim, or it maybe cannot be gc.

    anim.animator = null;
  }
};

p.onResume = function () {
  var array = this._anims.array;

  for (var i = 0; i < array.length; ++i) {
    var anim = array[i]; // rebind animator to anim

    anim.animator = this;
    anim.resume();
  }
};

p._reloadClip = function (state) {
  initClipData(this.target, state);
}; // 这个方法应该是 SampledAnimCurve 才能用


function createBatchedProperty(propPath, firstDotIndex, mainValue, animValue) {
  mainValue = mainValue.clone();
  var nextValue = mainValue;
  var leftIndex = firstDotIndex + 1;
  var rightIndex = propPath.indexOf('.', leftIndex); // scan property path

  while (rightIndex !== -1) {
    var nextName = propPath.slice(leftIndex, rightIndex);
    nextValue = nextValue[nextName];
    leftIndex = rightIndex + 1;
    rightIndex = propPath.indexOf('.', leftIndex);
  }

  var lastPropName = propPath.slice(leftIndex);
  nextValue[lastPropName] = animValue;
  return mainValue;
}

if (CC_TEST) {
  cc._Test.createBatchedProperty = createBatchedProperty;
}

function initClipData(root, state) {
  var clip = state.clip;
  state.duration = clip.duration;
  state.speed = clip.speed;
  state.wrapMode = clip.wrapMode;
  state.frameRate = clip.sample;

  if ((state.wrapMode & WrapModeMask.Loop) === WrapModeMask.Loop) {
    state.repeatCount = Infinity;
  } else {
    state.repeatCount = 1;
  }

  var curves = state.curves = clip.createCurves(state, root); // events curve

  var events = clip.events;

  if (!CC_EDITOR && events) {
    var curve;

    for (var i = 0, l = events.length; i < l; i++) {
      if (!curve) {
        curve = new EventAnimCurve();
        curve.target = root;
        curves.push(curve);
      }

      var eventData = events[i];
      var ratio = eventData.frame / state.duration;
      var eventInfo = void 0;
      var index = binarySearch(curve.ratios, ratio);

      if (index >= 0) {
        eventInfo = curve.events[index];
      } else {
        eventInfo = new EventInfo();
        curve.ratios.push(ratio);
        curve.events.push(eventInfo);
      }

      eventInfo.add(eventData.func, eventData.params);
    }
  }
}

if (CC_TEST) {
  cc._Test.initClipData = initClipData;
}

module.exports = AnimationAnimator;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFuaW1hdGlvbi1hbmltYXRvci5qcyJdLCJuYW1lcyI6WyJqcyIsImNjIiwiUGxheWFibGUiLCJyZXF1aXJlIiwiRXZlbnRBbmltQ3VydmUiLCJFdmVudEluZm8iLCJXcmFwTW9kZU1hc2siLCJiaW5hcnlTZWFyY2giLCJiaW5hcnlTZWFyY2hFcHNpbG9uIiwiQW5pbWF0aW9uQW5pbWF0b3IiLCJ0YXJnZXQiLCJhbmltYXRpb24iLCJjYWxsIiwiX2FuaW1zIiwiYXJyYXkiLCJNdXRhYmxlRm9yd2FyZEl0ZXJhdG9yIiwiZXh0ZW5kIiwicCIsInByb3RvdHlwZSIsInBsYXlTdGF0ZSIsInN0YXRlIiwic3RhcnRUaW1lIiwiY2xpcCIsImN1cnZlTG9hZGVkIiwiaW5pdENsaXBEYXRhIiwiYW5pbWF0b3IiLCJwbGF5Iiwic2V0VGltZSIsInN0b3BTdGF0ZXNFeGNlcHQiLCJpdGVyYXRvciIsImkiLCJsZW5ndGgiLCJhbmltIiwic3RvcFN0YXRlIiwiYWRkQW5pbWF0aW9uIiwiaW5kZXgiLCJpbmRleE9mIiwicHVzaCIsIl9zZXRFdmVudFRhcmdldCIsInJlbW92ZUFuaW1hdGlvbiIsImZhc3RSZW1vdmVBdCIsInN0b3AiLCJlcnJvcklEIiwic2FtcGxlIiwicGF1c2VTdGF0ZSIsInBhdXNlIiwicmVzdW1lU3RhdGUiLCJyZXN1bWUiLCJpc1BhdXNlZCIsInNldFN0YXRlVGltZSIsInRpbWUiLCJ1bmRlZmluZWQiLCJvblN0b3AiLCJvblBhdXNlIiwib25SZXN1bWUiLCJfcmVsb2FkQ2xpcCIsImNyZWF0ZUJhdGNoZWRQcm9wZXJ0eSIsInByb3BQYXRoIiwiZmlyc3REb3RJbmRleCIsIm1haW5WYWx1ZSIsImFuaW1WYWx1ZSIsImNsb25lIiwibmV4dFZhbHVlIiwibGVmdEluZGV4IiwicmlnaHRJbmRleCIsIm5leHROYW1lIiwic2xpY2UiLCJsYXN0UHJvcE5hbWUiLCJDQ19URVNUIiwiX1Rlc3QiLCJyb290IiwiZHVyYXRpb24iLCJzcGVlZCIsIndyYXBNb2RlIiwiZnJhbWVSYXRlIiwiTG9vcCIsInJlcGVhdENvdW50IiwiSW5maW5pdHkiLCJjdXJ2ZXMiLCJjcmVhdGVDdXJ2ZXMiLCJldmVudHMiLCJDQ19FRElUT1IiLCJjdXJ2ZSIsImwiLCJldmVudERhdGEiLCJyYXRpbyIsImZyYW1lIiwiZXZlbnRJbmZvIiwicmF0aW9zIiwiYWRkIiwiZnVuYyIsInBhcmFtcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBeUJBLElBQU1BLEVBQUUsR0FBR0MsRUFBRSxDQUFDRCxFQUFkOztBQUNBLElBQU1FLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFlBQUQsQ0FBeEI7O2VBQ3NDQSxPQUFPLENBQUMsb0JBQUQ7SUFBckNDLDBCQUFBQTtJQUFnQkMscUJBQUFBOztBQUN4QixJQUFNQyxZQUFZLEdBQUdILE9BQU8sQ0FBQyxTQUFELENBQVAsQ0FBbUJHLFlBQXhDOztBQUNBLElBQU1DLFlBQVksR0FBR0osT0FBTyxDQUFDLDZCQUFELENBQVAsQ0FBdUNLLG1CQUE1RCxFQUVBOzs7QUFFQSxTQUFTQyxpQkFBVCxDQUE0QkMsTUFBNUIsRUFBb0NDLFNBQXBDLEVBQStDO0FBQzNDVCxFQUFBQSxRQUFRLENBQUNVLElBQVQsQ0FBYyxJQUFkO0FBQ0EsT0FBS0YsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsT0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxPQUFLRSxNQUFMLEdBQWMsSUFBSWIsRUFBRSxDQUFDYyxLQUFILENBQVNDLHNCQUFiLENBQW9DLEVBQXBDLENBQWQ7QUFDSDs7QUFDRGYsRUFBRSxDQUFDZ0IsTUFBSCxDQUFVUCxpQkFBVixFQUE2QlAsUUFBN0I7QUFDQSxJQUFJZSxDQUFDLEdBQUdSLGlCQUFpQixDQUFDUyxTQUExQjs7QUFFQUQsQ0FBQyxDQUFDRSxTQUFGLEdBQWMsVUFBVUMsS0FBVixFQUFpQkMsU0FBakIsRUFBNEI7QUFDdEMsTUFBSSxDQUFDRCxLQUFLLENBQUNF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NkMsS0FBWjtBQUNIOztBQUVELFVBQUlFLFNBQVMsR0FBR0osTUFBTSxDQUFDbEQsQ0FBRCxDQUF0QjtBQUNBLFVBQUl1RCxLQUFLLEdBQUdELFNBQVMsQ0FBQ0UsS0FBVixHQUFrQmxFLEtBQUssQ0FBQ21ELFFBQXBDO0FBRUEsVUFBSWdCLFNBQVMsU0FBYjtBQUNBLFVBQUlwRCxLQUFLLEdBQUc1QixZQUFZLENBQUMyRSxLQUFLLENBQUNNLE1BQVAsRUFBZUgsS0FBZixDQUF4Qjs7QUFDQSxVQUFJbEQsS0FBSyxJQUFJLENBQWIsRUFBZ0I7QUFDWm9ELFFBQUFBLFNBQVMsR0FBR0wsS0FBSyxDQUFDRixNQUFOLENBQWE3QyxLQUFiLENBQVo7QUFDSCxPQUZELE1BR0s7QUFDRG9ELFFBQUFBLFNBQVMsR0FBRyxJQUFJbEYsU0FBSixFQUFaO0FBQ0E2RSxRQUFBQSxLQUFLLENBQUNNLE1BQU4sQ0FBYW5ELElBQWIsQ0FBa0JnRCxLQUFsQjtBQUNBSCxRQUFBQSxLQUFLLENBQUNGLE1BQU4sQ0FBYTNDLElBQWIsQ0FBa0JrRCxTQUFsQjtBQUNIOztBQUVEQSxNQUFBQSxTQUFTLENBQUNFLEdBQVYsQ0FBY0wsU0FBUyxDQUFDTSxJQUF4QixFQUE4Qk4sU0FBUyxDQUFDTyxNQUF4QztBQUNIO0FBQ0o7QUFDSjs7QUFFRCxJQUFJdkIsT0FBSixFQUFhO0FBQ1RuRSxFQUFBQSxFQUFFLENBQUNvRSxLQUFILENBQVM3QyxZQUFULEdBQXdCQSxZQUF4QjtBQUNIOztBQUdEb0UsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEYsaUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAxOCBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcbiBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXG4gdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxuXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbiBUSEUgU09GVFdBUkUuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuY29uc3QganMgPSBjYy5qcztcbmNvbnN0IFBsYXlhYmxlID0gcmVxdWlyZSgnLi9wbGF5YWJsZScpO1xuY29uc3QgeyBFdmVudEFuaW1DdXJ2ZSwgRXZlbnRJbmZvIH0gPSByZXF1aXJlKCcuL2FuaW1hdGlvbi1jdXJ2ZXMnKTtcbmNvbnN0IFdyYXBNb2RlTWFzayA9IHJlcXVpcmUoJy4vdHlwZXMnKS5XcmFwTW9kZU1hc2s7XG5jb25zdCBiaW5hcnlTZWFyY2ggPSByZXF1aXJlKCcuLi9jb3JlL3V0aWxzL2JpbmFyeS1zZWFyY2gnKS5iaW5hcnlTZWFyY2hFcHNpbG9uO1xuXG4vLyBUaGUgYWN0dWFsIGFuaW1hdG9yIGZvciBBbmltYXRpb24gQ29tcG9uZW50XG5cbmZ1bmN0aW9uIEFuaW1hdGlvbkFuaW1hdG9yICh0YXJnZXQsIGFuaW1hdGlvbikge1xuICAgIFBsYXlhYmxlLmNhbGwodGhpcyk7XG4gICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7XG4gICAgdGhpcy5hbmltYXRpb24gPSBhbmltYXRpb247XG5cbiAgICB0aGlzLl9hbmltcyA9IG5ldyBqcy5hcnJheS5NdXRhYmxlRm9yd2FyZEl0ZXJhdG9yKFtdKTtcbn1cbmpzLmV4dGVuZChBbmltYXRpb25BbmltYXRvciwgUGxheWFibGUpO1xubGV0IHAgPSBBbmltYXRpb25BbmltYXRvci5wcm90b3R5cGU7XG5cbnAucGxheVN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBzdGFydFRpbWUpIHtcbiAgICBpZiAoIXN0YXRlLmNsaXApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghc3RhdGUuY3VydmVMb2FkZWQpIHtcbiAgICAgICAgaW5pdENsaXBEYXRhKHRoaXMudGFyZ2V0LCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgc3RhdGUuYW5pbWF0b3IgPSB0aGlzO1xuICAgIHN0YXRlLnBsYXkoKTtcblxuICAgIGlmICh0eXBlb2Ygc3RhcnRUaW1lID09PSAnbnVtYmVyJykge1xuICAgICAgICBzdGF0ZS5zZXRUaW1lKHN0YXJ0VGltZSk7XG4gICAgfVxuXG4gICAgdGhpcy5wbGF5KCk7XG59O1xuXG5wLnN0b3BTdGF0ZXNFeGNlcHQgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBsZXQgaXRlcmF0b3IgPSB0aGlzLl9hbmltcztcbiAgICBsZXQgYXJyYXkgPSBpdGVyYXRvci5hcnJheTtcbiAgICBmb3IgKGl0ZXJhdG9yLmkgPSAwOyBpdGVyYXRvci5pIDwgYXJyYXkubGVuZ3RoOyArK2l0ZXJhdG9yLmkpIHtcbiAgICAgICAgbGV0IGFuaW0gPSBhcnJheVtpdGVyYXRvci5pXTtcbiAgICAgICAgaWYgKGFuaW0gPT09IHN0YXRlKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RvcFN0YXRlKGFuaW0pO1xuICAgIH1cbn07XG5cbnAuYWRkQW5pbWF0aW9uID0gZnVuY3Rpb24gKGFuaW0pIHtcbiAgICBsZXQgaW5kZXggPSB0aGlzLl9hbmltcy5hcnJheS5pbmRleE9mKGFuaW0pO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgdGhpcy5fYW5pbXMucHVzaChhbmltKTtcbiAgICB9XG5cbiAgICBhbmltLl9zZXRFdmVudFRhcmdldCh0aGlzLmFuaW1hdGlvbik7XG59O1xuXG5wLnJlbW92ZUFuaW1hdGlvbiA9IGZ1bmN0aW9uIChhbmltKSB7XG4gICAgbGV0IGluZGV4ID0gdGhpcy5fYW5pbXMuYXJyYXkuaW5kZXhPZihhbmltKTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICB0aGlzLl9hbmltcy5mYXN0UmVtb3ZlQXQoaW5kZXgpO1xuXG4gICAgICAgIGlmICh0aGlzLl9hbmltcy5hcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYy5lcnJvcklEKDM5MDgpO1xuICAgIH1cblxuICAgIGFuaW0uYW5pbWF0b3IgPSBudWxsO1xufTtcblxucC5zYW1wbGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGl0ZXJhdG9yID0gdGhpcy5fYW5pbXM7XG4gICAgbGV0IGFycmF5ID0gaXRlcmF0b3IuYXJyYXk7XG4gICAgZm9yIChpdGVyYXRvci5pID0gMDsgaXRlcmF0b3IuaSA8IGFycmF5Lmxlbmd0aDsgKytpdGVyYXRvci5pKSB7XG4gICAgICAgIGxldCBhbmltID0gYXJyYXlbaXRlcmF0b3IuaV07XG4gICAgICAgIGFuaW0uc2FtcGxlKCk7XG4gICAgfVxufTtcblxucC5zdG9wU3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgc3RhdGUuc3RvcCgpO1xuICAgIH1cbn07XG5cbnAucGF1c2VTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIGlmIChzdGF0ZSkge1xuICAgICAgICBzdGF0ZS5wYXVzZSgpO1xuICAgIH1cbn07XG5cbnAucmVzdW1lU3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgc3RhdGUucmVzdW1lKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNQYXVzZWQpIHtcbiAgICAgICAgdGhpcy5yZXN1bWUoKTtcbiAgICB9XG59O1xuXG5wLnNldFN0YXRlVGltZSA9IGZ1bmN0aW9uIChzdGF0ZSwgdGltZSkge1xuICAgIGlmICh0aW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgICAgICBzdGF0ZS5zZXRUaW1lKHRpbWUpO1xuICAgICAgICAgICAgc3RhdGUuc2FtcGxlKCk7XG4gICAgICAgIH0gICAgXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB0aW1lID0gc3RhdGU7XG5cbiAgICAgICAgbGV0IGFycmF5ID0gdGhpcy5fYW5pbXMuYXJyYXk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIGxldCBhbmltID0gYXJyYXlbaV07XG4gICAgICAgICAgICBhbmltLnNldFRpbWUodGltZSk7XG4gICAgICAgICAgICBhbmltLnNhbXBsZSgpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxucC5vblN0b3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGl0ZXJhdG9yID0gdGhpcy5fYW5pbXM7XG4gICAgbGV0IGFycmF5ID0gaXRlcmF0b3IuYXJyYXk7XG4gICAgZm9yIChpdGVyYXRvci5pID0gMDsgaXRlcmF0b3IuaSA8IGFycmF5Lmxlbmd0aDsgKytpdGVyYXRvci5pKSB7XG4gICAgICAgIGxldCBhbmltID0gYXJyYXlbaXRlcmF0b3IuaV07XG4gICAgICAgIGFuaW0uc3RvcCgpO1xuICAgIH1cbn07XG5cbnAub25QYXVzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgYXJyYXkgPSB0aGlzLl9hbmltcy5hcnJheTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKSB7XG4gICAgICAgIGxldCBhbmltID0gYXJyYXlbaV07XG4gICAgICAgIGFuaW0ucGF1c2UoKTtcblxuICAgICAgICAvLyBuZWVkIHRvIHVuYmluZCBhbmltYXRvciB0byBhbmltLCBvciBpdCBtYXliZSBjYW5ub3QgYmUgZ2MuXG4gICAgICAgIGFuaW0uYW5pbWF0b3IgPSBudWxsO1xuICAgIH1cbn07XG5cbnAub25SZXN1bWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGFycmF5ID0gdGhpcy5fYW5pbXMuYXJyYXk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSkge1xuICAgICAgICBsZXQgYW5pbSA9IGFycmF5W2ldO1xuICAgICAgICBcbiAgICAgICAgLy8gcmViaW5kIGFuaW1hdG9yIHRvIGFuaW1cbiAgICAgICAgYW5pbS5hbmltYXRvciA9IHRoaXM7XG5cbiAgICAgICAgYW5pbS5yZXN1bWUoKTtcbiAgICB9XG59O1xuXG5wLl9yZWxvYWRDbGlwID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgaW5pdENsaXBEYXRhKHRoaXMudGFyZ2V0LCBzdGF0ZSk7XG59O1xuXG4vLyDov5nkuKrmlrnms5XlupTor6XmmK8gU2FtcGxlZEFuaW1DdXJ2ZSDmiY3og73nlKhcbmZ1bmN0aW9uIGNyZWF0ZUJhdGNoZWRQcm9wZXJ0eSAocHJvcFBhdGgsIGZpcnN0RG90SW5kZXgsIG1haW5WYWx1ZSwgYW5pbVZhbHVlKSB7XG4gICAgbWFpblZhbHVlID0gbWFpblZhbHVlLmNsb25lKCk7XG4gICAgbGV0IG5leHRWYWx1ZSA9IG1haW5WYWx1ZTtcbiAgICBsZXQgbGVmdEluZGV4ID0gZmlyc3REb3RJbmRleCArIDE7XG4gICAgbGV0IHJpZ2h0SW5kZXggPSBwcm9wUGF0aC5pbmRleE9mKCcuJywgbGVmdEluZGV4KTtcblxuICAgIC8vIHNjYW4gcHJvcGVydHkgcGF0aFxuICAgIHdoaWxlIChyaWdodEluZGV4ICE9PSAtMSkge1xuICAgICAgICBsZXQgbmV4dE5hbWUgPSBwcm9wUGF0aC5zbGljZShsZWZ0SW5kZXgsIHJpZ2h0SW5kZXgpO1xuICAgICAgICBuZXh0VmFsdWUgPSBuZXh0VmFsdWVbbmV4dE5hbWVdO1xuICAgICAgICBsZWZ0SW5kZXggPSByaWdodEluZGV4ICsgMTtcbiAgICAgICAgcmlnaHRJbmRleCA9IHByb3BQYXRoLmluZGV4T2YoJy4nLCBsZWZ0SW5kZXgpO1xuICAgIH1cbiAgICBsZXQgbGFzdFByb3BOYW1lID0gcHJvcFBhdGguc2xpY2UobGVmdEluZGV4KTtcbiAgICBuZXh0VmFsdWVbbGFzdFByb3BOYW1lXSA9IGFuaW1WYWx1ZTtcblxuICAgIHJldHVybiBtYWluVmFsdWU7XG59XG5cbmlmIChDQ19URVNUKSB7XG4gICAgY2MuX1Rlc3QuY3JlYXRlQmF0Y2hlZFByb3BlcnR5ID0gY3JlYXRlQmF0Y2hlZFByb3BlcnR5O1xufVxuXG5cbmZ1bmN0aW9uIGluaXRDbGlwRGF0YSAocm9vdCwgc3RhdGUpIHtcbiAgICBsZXQgY2xpcCA9IHN0YXRlLmNsaXA7XG5cbiAgICBzdGF0ZS5kdXJhdGlvbiA9IGNsaXAuZHVyYXRpb247XG4gICAgc3RhdGUuc3BlZWQgPSBjbGlwLnNwZWVkO1xuICAgIHN0YXRlLndyYXBNb2RlID0gY2xpcC53cmFwTW9kZTtcbiAgICBzdGF0ZS5mcmFtZVJhdGUgPSBjbGlwLnNhbXBsZTtcblxuICAgIGlmICgoc3RhdGUud3JhcE1vZGUgJiBXcmFwTW9kZU1hc2suTG9vcCkgPT09IFdyYXBNb2RlTWFzay5Mb29wKSB7XG4gICAgICAgIHN0YXRlLnJlcGVhdENvdW50ID0gSW5maW5pdHk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBzdGF0ZS5yZXBlYXRDb3VudCA9IDE7XG4gICAgfVxuXG4gICAgbGV0IGN1cnZlcyA9IHN0YXRlLmN1cnZlcyA9IGNsaXAuY3JlYXRlQ3VydmVzKHN0YXRlLCByb290KTtcblxuICAgIC8vIGV2ZW50cyBjdXJ2ZVxuXG4gICAgbGV0IGV2ZW50cyA9IGNsaXAuZXZlbnRzO1xuXG4gICAgaWYgKCFDQ19FRElUT1IgJiYgZXZlbnRzKSB7XG4gICAgICAgIGxldCBjdXJ2ZTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGV2ZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIGlmICghY3VydmUpIHtcbiAgICAgICAgICAgICAgICBjdXJ2ZSA9IG5ldyBFdmVudEFuaW1DdXJ2ZSgpO1xuICAgICAgICAgICAgICAgIGN1cnZlLnRhcmdldCA9IHJvb3Q7XG4gICAgICAgICAgICAgICAgY3VydmVzLnB1c2goY3VydmUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZXZlbnREYXRhID0gZXZlbnRzW2ldO1xuICAgICAgICAgICAgbGV0IHJhdGlvID0gZXZlbnREYXRhLmZyYW1lIC8gc3RhdGUuZHVyYXRpb247XG5cbiAgICAgICAgICAgIGxldCBldmVudEluZm87XG4gICAgICAgICAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2goY3VydmUucmF0aW9zLCByYXRpbyk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICAgICAgICAgIGV2ZW50SW5mbyA9IGN1cnZlLmV2ZW50c1tpbmRleF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBldmVudEluZm8gPSBuZXcgRXZlbnRJbmZvKCk7XG4gICAgICAgICAgICAgICAgY3VydmUucmF0aW9zLnB1c2gocmF0aW8pO1xuICAgICAgICAgICAgICAgIGN1cnZlLmV2ZW50cy5wdXNoKGV2ZW50SW5mbyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGV2ZW50SW5mby5hZGQoZXZlbnREYXRhLmZ1bmMsIGV2ZW50RGF0YS5wYXJhbXMpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5pZiAoQ0NfVEVTVCkge1xuICAgIGNjLl9UZXN0LmluaXRDbGlwRGF0YSA9IGluaXRDbGlwRGF0YTtcbn1cblxuXG5tb2R1bGUuZXhwb3J0cyA9IEFuaW1hdGlvbkFuaW1hdG9yO1xuIl19